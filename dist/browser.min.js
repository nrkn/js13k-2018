let s=()=>{let t=t=>new Promise(e=>{let n=new Image;n.onload=(()=>e(n)),n.src=t}),e=t=>t[n(t.length)],n=(t,e=0)=>~~(Math.random()*t)+e,o=(t,e)=>Math.max(t,e)-Math.min(t,e),r=([t,e])=>[[t-1,e],[t+1,e],[t,e-1],[t,e+1]],s=(t,e,n)=>r(e).filter(e=>t[e[1]][e[0]]===n),l=(t,[n,r],s,l)=>{let c=t.filter(([t,e])=>o(t,n)>=s&&o(e,r)>=s&&o(t,n)<=l&&o(e,r)<=l);return e(c)},h=([t,e],n)=>{let o=[],s=[[t,e,0]],l=[],c=([t,e,c])=>{p([t,e])&&n([t,e])&&(l[128*e+t]||(o.push([t,e,c]),l[128*e+t]=!0,s.push(...r([t,e]).map(([t,e])=>[t,e,c+1]))))};for(;s.length;)c(s.shift());return o},f=(t,[e,n])=>{let o=[],[s,l]=t[0],c=((t,[e,n])=>{for(let o=0;o<t.length;o++)if(t[o][0]===e&&t[o][1]===n)return t[o]})(t,[e,n]);if(!c)return o;let h=[c],f=([e,n,c])=>{if(o.unshift([e,n]),e===s&&n===l)return;let f;r([e,n]).forEach(([e,n])=>{let o=t.find(([t,o])=>t===e&&o===n);if(o){let[,,t]=o;t<c&&(c=t,f=o)}}),f&&h.push(f)};for(;h.length;)f(h.shift());return o},g=([t,e],[n,r])=>{let s=o(t,n),l=o(e,r),c=t,h=e;return s>l&&(n>t&&(c=t+1),t>n&&(c=t-1)),l>s&&(r>e&&(h=e+1),e>r&&(h=e-1)),[c,h]},a=([t,n],[o,s],l=p,c=.66)=>{let h=[],f=([t,n])=>{d(h,[t,n])||h.push([t,n]),t===o&&n===s||f(Math.random()<c?e(r([t,n]).filter(l))||[t,n]:g([t,n],[o,s]))};return f([t,n]),h},i=t=>[3===t?21:1===t?107:n(86,21),0===t?21:2===t?107:n(86,21)],u=()=>[n(86,21),n(86,21)],d=(t,[e,n])=>{for(let o=0;o<t.length;o++)if(t[o][0]===e&&t[o][1]===n)return!0;return!1},p=([t,e])=>t>=0&&t<=127&&e>=0&&e<=127,m=([t,e])=>t>=8&&t<=120&&e>=8&&e<=120,I=()=>{let t=[];for(let e=0;e<128;e++){let e=[];for(let t=0;t<128;t++)e.push(1);t.push(e)}return t},S=(t,e,n)=>{for(let o=0;o<e.length;o++){let[r,s]=e[o];t[s][r]=n([r,s])}},E=()=>{let t=I(),o=n(15,10),r=[i(0),i(1),i(2),i(3)];for(let t=4;t<o;t++)r.push(u());for(let e=1;e<o;e++){let n=a(r[e-1],r[e],m);S(t,n,()=>2)}let c=((t,e)=>{let n=[];for(let o=0;o<128;o++)for(let r=0;r<128;r++)t[o][r]===e&&n.push([r,o]);return n})(t,2),g=c.slice();((t,n,o=4096)=>{for(;n.length<o;){let[o,r]=e(n),l=s(t,[o,r],1).filter(m);if(l.length){let[o,r]=e(l);d(n,[o,r])||(n.push([o,r]),t[r][o]=2)}}})(t,c);let p=h([0,0],([e,n])=>1===t[n][e]);S(t,p,()=>0),((t,e)=>{for(let o=0;o<128;o++)for(let r=0;r<128;r++)2===t[o][r]&&(s(t,[r,o],0).length?t[o][r]=n(3)+14:d(e,[r,o])?t[o][r]=n(6)+2:t[o][r]=n(7)+2),1===t[o][r]&&(t[o][r]=n(2)+7)})(t,g);let[E,C]=(t=>{let e=128,n=[0,0];for(let o=0;o<t.length;o++){let[r,s]=t[o];r<e&&(e=r,n=[r,s])}return n})(c);let N;for(;!N;)N=l(g,[E,C],n(5)+10,n(5)+20);let[w,O]=N,[k,R]=l(g,[w,O],n(5)+10,n(5)+20),T=[[E,C],[w,O],[k,R]];for(;T.length<15;){let[o,r]=e(T),s=12*n(10),c=12*n(10),a=l(g,[s,c],1,12),i=h([o,r],([e,n])=>0!==t[n][e]);if(a&&i.length){let e=f(i,a);T.push(a),S(t,e,([e,n])=>t[n][e]>=14&&t[n][e]<17?t[n][e]:2)}}for(let e=2;e<15;e++){let[n,o]=T[e];t[o][n]=17}return[3,E,C,t,0,E,C]},C=t=>t<2||8===t||17===t||24===t||21===t||22===t||23===t||18===t||19===t||20===t,N=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","","ERROR:"," SYSTEM OFFLINE","","EMERGENCY OPS:",""],[["DIAGNOSTICS",5],["SYNTHESIZE",6]]],[2,["DIAGNOSTICS","","MAIN SYSTEM:"," OFFLINE",""," PROBLEM:","  6 CAPS BLOWN","","SYNTHESIZE:"," ONLINE"],[]],[2,["SYNTHESIZE","","SYNTHDB:"," OFFLINE","","EMERGENCY OPS:",""],[["BASIC RATIONS",4]]],E(),[1,["I should","investigate"]]],w=t=>{let e=$[0]()[6],n=$[0]()[7];c.className=e,c.width=c.height=160,3===n[0]&&(T(t),y()),0===n[0]&&"s.png"===n[1]&&A.drawImage(L,0,0),1===n[0]&&R(n[1]),requestAnimationFrame(w)},O=(t="",e=0,n=0)=>A.drawImage(M,8*(t.charCodeAt(0)-32),0,8,8,8*e,8*n,8,8),k=(t="",e=0,n=0)=>{for(let o=0;o<t.length;o++)O(t[o],e+o,n)},R=t=>{let e=~~((20-t.length)/2);for(let n=0;n<t.length;n++){let o=~~((20-t[n].length)/2);k(t[n],o,e+n)}},T=t=>{let e=~~(t/500)%2?0:1,n=$[0]()[8],o=$[0]()[7],r=o[3],s=o[1],l=o[2],c=o[4],h=o[5],f=o[6],g=$[0]()[2],a=$[0]()[0],i=$[0]()[4]>=18||$[0]()[4]<6;for(let t=0;t<9;t++)for(let o=0;o<9;o++){let u=s-4+o,d=l-4+t;let m=16*e;if(p([u,d])){let t=r[d][u];t&&(m=16*t)}if(A.drawImage(Y,m,0,16,16,16*(o+1),16*(t+1),16,16),0===c&&i)for(let r=0;r<n.length;r++){let s=n[r],l=s[0],c=s[1],h=s[2];l===u&&c===d&&s[3]>0&&(m=16*(7+e)+16*h*2,A.drawImage(F,m,0,16,16,16*(o+1),16*(t+1),16,16))}4===o&&4===t&&(m=g?16*e+16*a*2:64,A.drawImage(F,m,0,16,16,16*(o+1),16*(t+1),16,16)),0===c&&u===h-2&&d===f&&A.drawImage(F,80,0,16,16,16*(o+1),16*(t+1),16,16),0===c&&u===h-1&&d===f&&A.drawImage(F,96,0,16,16,16*(o+1),16*(t+1),16,16)}},y=()=>{let t=$[0]()[1],e=$[0]()[2];k(`RANGER DOWN   ${$[2]()}`,.5,.5),A.drawImage(Y,160,0,16,16,0,16,16,16),k(`${e}`,e<10?.5:0,4),A.drawImage(Y,144,0,16,16,0,48,16,16),k(`${t}`,t<10?.5:0,8)},A=c.getContext("2d");let M,Y,F,L,$=(()=>{let t,e,o,r,s,l,c,f,a;let i=()=>{for(t=0,e=5,o=2,r=10,s=17,l=55,N[7]=E(),f=[N[7],N[1],N[0]],c="",a=[];a.length<42;){let t=n(128),e=n(128),o=n(2),r=n(2)+1,s=N[7],l=s[3][e][t],c=s[1],h=s[2];C(l)||d(a,[t,e])||c===t&&h===e||a.push([t,e,o,r])}},u=()=>{60==++l&&(l=0,6==++s&&(c="",f.push(N[2])),18===s&&(c="i",f.push(N[3])),e>0?(e--,o<r&&o++):o--),24===s&&(s=0);for(let t=0;t<a.length;t++){let e=a[t],r=e[0],s=e[1],l=N[7],c=l[1],h=l[2],f=[r,s];if(Math.random()<.66){let t=g([r,s],[c,h]);f[0]=t[0],f[1]=t[1]}else n(2)?f[0]=r+(n(3)-1):f[1]=s+(n(3)-1);let i=l[3][f[1]][f[0]];C(i)||d(a,[f[0],f[1]])||c===f[0]&&h===f[1]||(e[0]=f[0],e[1]=f[1],f[0]<r&&(e[2]=1),f[0]>r&&(e[2]=0)),c===f[0]&&h===f[1]&&n(2)&&o>0&&e[3]>0&&o--}};return i(),[()=>[t,e,o,r,s,l,(()=>0===f[f.length-1][0]?"g":1===f[f.length-1][0]?"g":2===f[f.length-1][0]?"a":c)(),f[f.length-1],a],i,()=>`${s<10?"0":""}${s}:${l<10?"0":""}${l}`,u,(e,r)=>{let s=f[f.length-1];if(3!==s[0])return;let l;if(u(),-1===e&&(t=1),1===e&&(t=0),e=s[1]+e,r=s[2]+r,0===s[4])for(let t=0;t<a.length;t++)a[t][0]===e&&a[t][1]===r&&a[t][3]>0&&(l=a[t]);o>0&&p([e,r])&&!C(s[3][r][e])&&!l&&(s[1]=e,s[2]=r),0===s[4]&&(17===s[3][r][e]&&f.push((()=>{let t=I(),e=h([0,0],([e,n])=>1===t[n][e]);return S(t,e,()=>24),t[20][19]=18,t[20][20]=19,t[20][21]=20,t[21][19]=2,t[21][20]=2,t[21][21]=2,t[22][19]=21,t[22][20]=22,t[22][21]=23,[3,21,21,t,1,21,21]})()),r===s[6]&&e===s[5]-1&&f.push(N[8]),l&&n(2)&&l[3]--),1===s[4]&&23===s[3][r][e]&&f.pop()},()=>{f.pop(),f.length||(f=[N[7]])}]})();document.onkeyup=(t=>{let e=$[0]()[7];3===e[0]&&(t=>{65!==t.keyCode&&37!==t.keyCode||$[4](-1,0),68!==t.keyCode&&39!==t.keyCode||$[4](1,0),87!==t.keyCode&&38!==t.keyCode||$[4](0,-1),83!==t.keyCode&&40!==t.keyCode||$[4](0,1)})(t),0!==e[0]&&1!==e[0]||32!==t.keyCode&&27!==t.keyCode&&13!==t.keyCode||$[5](),e[0]}),c.ontouchend=(t=>{let e=$[0]()[7];if(3!==e[0])0!==e[0]&&1!==e[0]||$[5](),e[0];else for(let e=0;e<t.changedTouches.length;e++){let n=c.getBoundingClientRect().width/10,r=~~(t.changedTouches[e].clientX/n)-1,s=~~(t.changedTouches[e].clientY/n)-1;if(4===r&&4===s)return;if(r<0||s<0)return;let l=o(r,4),h=o(s,4);let f=0,g=0;l>h?f=r>4?1:-1:l<h&&(g=s>4?1:-1),$[4](f,g)}}),((...e)=>Promise.all(e.map(t)))("f.gif","t.gif","p.gif","s.png").then(t=>{[M,Y,F,L]=t,requestAnimationFrame(w)})};s();