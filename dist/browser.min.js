let s=()=>{let e=e=>new Promise(t=>{let n=new Image;n.onload=(()=>t(n)),n.src=e}),t=e=>e[n(e.length)],n=(e,t=0)=>~~(Math.random()*e)+t,o=(e,t)=>Math.max(e,t)-Math.min(e,t),s=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]],r=(e,t,n)=>s(t).filter(t=>e[t[1]][t[0]]===n),l=(e,[n,s],r,l)=>{let h=e.filter(([e,t])=>o(e,n)>=r&&o(t,s)>=r&&o(e,n)<=l&&o(t,s)<=l);return t(h)},h=([e,t],n)=>{let o=[],r=[[e,t,0]],l=[],h=([e,t,h])=>{p([e,t])&&n([e,t])&&(l[128*t+e]||(o.push([e,t,h]),l[128*t+e]=!0,r.push(...s([e,t]).map(([e,t])=>[e,t,h+1]))))};for(;r.length;)h(r.shift());return o},g=(e,[t,n])=>{let o=[],[r,l]=e[0],h=((e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return e[o]})(e,[t,n]);if(!h)return o;let c=[h],g=([t,n,h])=>{if(o.unshift([t,n]),t===r&&n===l)return;let g;s([t,n]).forEach(([t,n])=>{let o=e.find(([e,o])=>e===t&&o===n);if(o){let[,,e]=o;e<h&&(h=e,g=o)}}),g&&c.push(g)};for(;c.length;)g(c.shift());return o},f=([e,t],[n,s])=>{let r=o(e,n),l=o(t,s),h=e,c=t;return r>l&&(n>e&&(h=e+1),e>n&&(h=e-1)),l>r&&(s>t&&(c=t+1),t>s&&(c=t-1)),[h,c]},a=([e,n],[o,r],l=p,h=.66)=>{let c=[],g=([e,n])=>{d(c,[e,n])||c.push([e,n]),e===o&&n===r||g(Math.random()<h?t(s([e,n]).filter(l))||[e,n]:f([e,n],[o,r]))};return g([e,n]),c},i=e=>[3===e?21:1===e?107:n(86,21),0===e?21:2===e?107:n(86,21)],u=()=>[n(86,21),n(86,21)],d=(e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return!0;return!1},p=([e,t])=>e>=0&&e<=127&&t>=0&&t<=127,S=([e,t])=>e>=8&&e<=120&&t>=8&&t<=120,C=()=>{let e=[];for(let t=0;t<128;t++){let t=[];for(let e=0;e<128;e++)t.push(1);e.push(t)}return e},I=(e,t,n)=>{for(let o=0;o<t.length;o++){let[s,r]=t[o];e[r][s]=n([s,r])}},m=()=>{let e=C(),o=n(15,10),s=[i(0),i(1),i(2),i(3)];for(let e=4;e<o;e++)s.push(u());for(let t=1;t<o;t++){let n=a(s[t-1],s[t],S);I(e,n,()=>2)}let c=((e,t)=>{let n=[];for(let o=0;o<128;o++)for(let s=0;s<128;s++)e[o][s]===t&&n.push([s,o]);return n})(e,2),f=c.slice();((e,n,o=4096)=>{for(;n.length<o;){let[o,s]=t(n),l=r(e,[o,s],1).filter(S);if(l.length){let[o,s]=t(l);d(n,[o,s])||(n.push([o,s]),e[s][o]=2)}}})(e,c);let p=h([0,0],([t,n])=>1===e[n][t]);I(e,p,()=>0),((e,t)=>{for(let o=0;o<128;o++)for(let s=0;s<128;s++)2===e[o][s]&&(r(e,[s,o],0).length?e[o][s]=n(3)+14:d(t,[s,o])?e[o][s]=n(6)+2:e[o][s]=n(7)+2),1===e[o][s]&&(e[o][s]=n(2)+7)})(e,f);let[m,E]=(e=>{let t=128,n=[0,0];for(let o=0;o<e.length;o++){let[s,r]=e[o];s<t&&(t=s,n=[s,r])}return n})(c);let N;for(;!N;)N=l(f,[m,E],n(5)+10,n(5)+20);let[k,y]=N,[O,R]=l(f,[k,y],n(5)+10,n(5)+20),M=[[m,E],[k,y],[O,R]];for(;M.length<15;){let[o,s]=t(M),r=12*n(10),c=12*n(10),a=l(f,[r,c],1,12),i=h([o,s],([t,n])=>0!==e[n][t]);if(a&&i.length){let t=g(i,a);M.push(a),I(e,t,([t,n])=>e[n][t]>=14&&e[n][t]<17?e[n][t]:2)}}for(let t=2;t<15;t++){let[n,o]=M[t];e[o][n]=17}return[3,m,E,e,0,m,E]},E=e=>e<2||8===e||17===e||24===e||21===e||22===e||23===e||18===e||19===e||20===e,N=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","--------------------","MAIN MENU","--------------------","ERROR:"," SYSTEM OFFLINE","","EMERGENCY OPS:","===================="],[["DIAGNOSTICS",5],["SYNTHESIZE",6]],0,"a"],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","--------------------","MAIN SYSTEM:"," OFFLINE",""," PROBLEM:","  6 CAPS BLOWN","","SYNTHESIZE:"," ONLINE"],[],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","--------------------","SYNTHDB:"," OFFLINE","","EMERGENCY OPS:","===================="],[["BASIC RATIONS",4]],0,"a"],m(),[1,["I should","investigate"]],[2,["Sleep?"],[["Yes",11],["No",-1]],0,"g"],[1,["I'm not tired!"]],[4,e=>e[8]()]],k=e=>{let t=G[0]()[6],n=G[0]()[7];c.className=t,c.width=c.height=160,3===n[0]&&(w(e),T()),0===n[0]&&"s.png"===n[1]&&A.drawImage(L,0,0),1===n[0]&&R(n[1]),2===n[0]&&M(n),requestAnimationFrame(k)},y=(e="",t=0,n=0)=>A.drawImage($,8*(e.charCodeAt(0)-32),0,8,8,8*t,8*n,8,8),O=(e="",t=0,n=0)=>{for(let o=0;o<e.length;o++)y(e[o],t+o,n)},R=e=>{let t=~~((20-e.length)/2);for(let n=0;n<e.length;n++){let o=~~((20-e[n].length)/2);O(e[n],o,t+n)}},M=e=>{for(let t=0;t<e[1].length;t++)O(e[1][t],0,t);O("<X>",17,0);let t=e[1].length%2?1:0;for(let n=0;n<e[2].length;n++)O(`${n+1} ${n===e[3]?"<":" "}${e[2][n][0]}${n===e[3]?">":" "}`,0,2*n+e[1].length+t)},w=e=>{let t=~~(e/500)%2?0:1,n=G[0]()[8],o=G[0]()[7],s=o[3],r=o[1],l=o[2],h=o[4],c=o[5],g=o[6],f=G[0]()[2],a=G[0]()[0],i=G[0]()[4]>=18||G[0]()[4]<6;for(let e=0;e<9;e++)for(let o=0;o<9;o++){let u=r-4+o,d=l-4+e;let S=16*t;if(p([u,d])){let e=s[d][u];e&&(S=16*e)}if(A.drawImage(Y,S,0,16,16,16*(o+1),16*(e+1),16,16),0===h&&i)for(let s=0;s<n.length;s++){let r=n[s],l=r[0],h=r[1],c=r[2];l===u&&h===d&&r[3]>0&&(S=16*(7+t)+16*c*2,A.drawImage(F,S,0,16,16,16*(o+1),16*(e+1),16,16))}4===o&&4===e&&(S=f?16*t+16*a*2:64,A.drawImage(F,S,0,16,16,16*(o+1),16*(e+1),16,16)),0===h&&u===c-2&&d===g&&A.drawImage(F,80,0,16,16,16*(o+1),16*(e+1),16,16),0===h&&u===c-1&&d===g&&A.drawImage(F,96,0,16,16,16*(o+1),16*(e+1),16,16)}},T=()=>{let e=G[0]()[1],t=G[0]()[2];O(`RANGER DOWN   ${G[2]()}`,.5,.5),A.drawImage(Y,160,0,16,16,0,16,16,16),O(`${t}`,t<10?.5:0,4),A.drawImage(Y,144,0,16,16,0,48,16,16),O(`${e}`,e<10?.5:0,8)},A=c.getContext("2d");let $,Y,F,L,G=(()=>{let e,t,o,s,r,l,c,g,a;let i=()=>{e=0,t=5,o=2,s=10,r=17,l=55,N[7]=m(),g=[N[7],N[1],N[0]],c="",a=[],S()},u=()=>{g.pop(),g.length||(g=[N[7]])},S=()=>{for(;a.length<42;){let e=n(128),t=n(128),o=n(2),s=n(2)+1,r=N[7],l=r[3][t][e],h=r[1],c=r[2];E(l)||d(a,[e,t])||h===e&&c===t||a.push([e,t,o,s])}},k=()=>{for(let e=0;e<a.length;e++){let t=a[e],s=t[0],l=t[1],h=g[g.length-1],c=N[7],i=c[1],u=c[2],p=[s,l];if(Math.random()<.66){let e=f([s,l],[i,u]);p[0]=e[0],p[1]=e[1]}else n(2)?p[0]=s+(n(3)-1):p[1]=l+(n(3)-1);let S=c[3][p[1]][p[0]];E(S)||d(a,[p[0],p[1]])||i===p[0]&&u===p[1]||(t[0]=p[0],t[1]=p[1],p[0]<s&&(t[2]=1),p[0]>s&&(t[2]=0)),3===h[0]&&0===h[4]&&(r>=18||r<6)&&i===p[0]&&u===p[1]&&n(2)&&o>0&&t[3]>0&&o--}},y=()=>{o<1||(60==++l&&(l=0,6==++r&&(c="",g.push(N[2])),18===r&&(c="i",g.push(N[3])),t>0?(t--,o<s&&o++):o--),24===r&&(r=0),k())};i();let O=[()=>[e,t,o,s,r,l,(()=>0===g[g.length-1][0]?"g":1===g[g.length-1][0]?"g":2===g[g.length-1][0]?g[g.length-1][4]:c)(),g[g.length-1],a],i,()=>`${r<10?"0":""}${r}:${l<10?"0":""}${l}`,y,(t,s)=>{let l=g[g.length-1];if(3!==l[0])return;let c;if(y(),-1===t&&(e=1),1===t&&(e=0),t=l[1]+t,s=l[2]+s,(r>=18||r<6)&&0===l[4])for(let e=0;e<a.length;e++)a[e][0]===t&&a[e][1]===s&&a[e][3]>0&&(c=a[e]);o>0&&p([t,s])&&!E(l[3][s][t])&&!c&&(l[1]=t,l[2]=s),0===l[4]&&(17===l[3][s][t]&&g.push((()=>{let e=C(),t=h([0,0],([t,n])=>1===e[n][t]);return I(e,t,()=>24),e[20][19]=18,e[20][20]=19,e[20][21]=20,e[21][19]=2,e[21][20]=2,e[21][21]=2,e[22][19]=21,e[22][20]=22,e[22][21]=23,[3,21,21,e,1,21,21]})()),s===l[6]&&t===l[5]-1&&g.push(N[8]),c&&n(2)&&c[3]--),1===l[4]&&(23===l[3][s][t]&&g.pop(),18===l[3][s][t]&&g.push(N[4]),20===l[3][s][t]&&(r>=18||r<6?g.push(N[9]):g.push(N[10])))},u,e=>{2===g[g.length-1][0]&&(g[g.length-1][3]=e)},()=>{if(2===g[g.length-1][0]){let e=g[g.length-1],t=e[3],n=e[2][t][1];-1===n?u():4===N[n][0]?(N[n][1](O),g.pop()):g.push(N[n])}},()=>{for(;5!==r||59!==l;)60==++l&&(l=0,r++,o<s&&o++),24===r&&(r=0),k()}];return O})();document.onkeyup=(e=>{let t=G[0]()[7];if(3===t[0]&&(e=>{65!==e.keyCode&&37!==e.keyCode||G[4](-1,0),68!==e.keyCode&&39!==e.keyCode||G[4](1,0),87!==e.keyCode&&38!==e.keyCode||G[4](0,-1),83!==e.keyCode&&40!==e.keyCode||G[4](0,1)})(e),0!==t[0]&&1!==t[0]||32!==e.keyCode&&27!==e.keyCode&&13!==e.keyCode||G[5](),2===t[0]){let n=t;27===e.keyCode&&G[5](),87!==e.keyCode&&38!==e.keyCode||n[3]>0&&G[6](n[3]-1),83!==e.keyCode&&40!==e.keyCode||n[3]<n[2].length-1&&G[6](n[3]+1),32!==e.keyCode&&13!==e.keyCode||G[7]()}}),c.ontouchend=(e=>{let t=G[0]()[7];for(let n=0;n<e.changedTouches.length;n++){let s=c.getBoundingClientRect().width/10,r=~~(e.changedTouches[n].clientX/s)-1,l=~~(e.changedTouches[n].clientY/s)-1;if(3===t[0]){if(4===r&&4===l)return;if(r<0||l<0)return;let e=o(r,4),t=o(l,4);let n=0,s=0;e>t?n=r>4?1:-1:e<t&&(s=l>4?1:-1),G[4](n,s)}if(0!==t[0]&&1!==t[0]||G[5](),2===t[0]){l<0&&G[5]();let e=t,n=e[1].length%2?1:0,o=(e[1].length+n)/2,s=e[2].length,r=l-o+1;r>=0&&r<s&&(r===e[3]?G[7]():G[6](r))}}}),((...t)=>Promise.all(t.map(e)))("f.gif","t.gif","p.gif","s.png").then(e=>{[$,Y,F,L]=e,requestAnimationFrame(k)})};s();