let s=()=>{let e=e=>new Promise(t=>{let n=new Image;n.onload=(()=>t(n)),n.src=e}),t=e=>e[n(e.length)],n=(e,t=0)=>~~(Math.random()*e)+t,o=(e,t)=>Math.max(e,t)-Math.min(e,t),s=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]],l=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1],[e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]],h=(e,t,n)=>s(t).filter(t=>e[t[1]][t[0]]===n),r=([e,t],[n,s])=>Math.hypot(o(e,n),o(t,s)),g=(e,t)=>{let n,o=25600;for(let s=0;s<t.length;s++){let l=r(e,t[s]);l<o&&(o=l,n=t[s])}return n},u=([e,t],n)=>{let o=[],l=[[e,t,0]],h=[],r=([e,t,r])=>{I([e,t])&&n([e,t])&&(h[160*t+e]||(o.push([e,t,r]),h[160*t+e]=1,l.push(...s([e,t]).map(([e,t])=>[e,t,r+1]))))};for(;l.length;)r(l.shift());return o},a=([e,t],[n,s])=>{let l=o(e,n),h=o(t,s),r=e,c=t;return l>h&&(n>e&&(r=e+1),e>n&&(r=e-1)),h>l&&(s>t&&(c=t+1),t>s&&(c=t-1)),[r,c]},f=([e,n],[o,l],h=I,r=.66)=>{let c=[],g=[],u=([e,n])=>{g[160*n+e]||(c.push([e,n]),g[160*n+e]=1),e===o&&n===l||u(Math.random()<r?t(s([e,n]).filter(h))||[e,n]:a([e,n],[o,l]))};return u([e,n]),c},i=e=>[3===e?20:1===e?140:n(120,20),0===e?20:2===e?140:n(120,20)],p=()=>[n(120,20),n(120,20)],d=(e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return!0;return!1},I=([e,t])=>e>=0&&e<=159&&t>=0&&t<=159,S=([e,t])=>e>=8&&e<=152&&t>=8&&t<=152,N=()=>{let e=[];for(let t=0;t<160;t++){let t=[];for(let e=0;e<160;e++)t.push(1);e.push(t)}return e},E=(e,t,n)=>{for(let o=0;o<t.length;o++){let[s,l]=t[o];e[l][s]=n([s,l])}},m=e=>{let t=0;let o=(e=>e.slice().sort(()=>n(3)-1))([0,3,6,9]);for(let s=0;s<160;s++)for(let l=0;l<160;l++)if(1===e[s][l]){let h=u([l,s],([t,n])=>1===e[n][t]);let r=0;h.length>5&&(r=t<4?o[t]:n(10),t++),E(e,h,r<3?()=>n(9)+2:r<6?()=>n(3)?n(4)+11:n(9)+2:r<9?()=>n(4)?n(3)+31:n(9)+2:()=>0)}},C=e=>{let o=N(),c=n(10,40),a=[i(0),i(1),i(2),i(3)];for(;a.length<c;)a.push(p());let d=[],I=a.slice();let C=I.pop();let k=C;for(;I.length;){let e=g(C,I),t=f(C,e,S,.33);d.push(...t),C=I.pop()}let R=f(C,k,S,.33);d.push(...R);for(let e=0;e<10;e++){let e=f(t(a),t(a),S,.33);d.push(...e)}let y=[];for(let e=0;e<a.length;e++)y.push(...l(a[e]));let O=((e,n=8448)=>{let o=e.slice(),l=[];for(let e=0;e<o.length;e++){let[t,n]=o[e];l[160*n+t]=1}for(;o.length<n;){let[e,n]=t(o),h=s([e,n]);if(h.length){let[e,n]=t(h);l[160*n+e]||(o.push([e,n]),l[160*n+e]=1)}}return o})((e=>{let t=[],n=[];for(let o=0;o<e.length;o++){let[s,l]=e[o];n[160*l+s]||(t.push(e[o]),n[160*l+s]=1)}return console.log("unique",e.length,t.length),t})([...a,...y,...d])),[A,M]=(e=>{let t=160,n=[0,0];for(let o=0;o<e.length;o++){let[s,l]=e[o];s<t&&(t=s,n=[s,l])}return n})(O);E(o,O,()=>2);let w=u([0,0],([e,t])=>1===o[t][e]);E(o,w,()=>0);let T=((e,t)=>t.slice().sort((t,n)=>r(e,t)-r(e,n)))([A,M],a),Y=f([A,M],T[0],S,.33);d.push(...Y),m(o),(e=>{for(let t=0;t<160;t++)for(let o=0;o<160;o++)2===e[t][o]&&(h(e,[o,t],0).length?e[t][o]=n(3)+17:e[t][o]=n(13)+2)})(o),E(o,d,([e,t])=>o[t][e]>=17&&o[t][e]<20?o[t][e]:2),E(o,y,([e,t])=>o[t][e]>=17&&o[t][e]<20?o[t][e]:n(9)+2);for(let t=0;t<T.length;t++){let[s,l]=T[t],h=n(10);0===t?o[l][s]=38:1===t?(o[l][s]=20,e[160*l+s]=[0,0]):t===T.length-1?o[l][s]=34:h<6?o[l][s]=n(3)+28:h<9?(o[l][s]=20,e[160*l+s]=[0,0]):o[l][s]=36}return[3,A,M,o,0,A,M]},k=e=>e<2||e>=11&&e<15||20===e||27===e||24===e||25===e||26===e||21===e||22===e||23===e||e>=28&&e<31||e>=31&&e<34,R=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","--------------------","MAIN MENU","","ERROR:"," SYSTEM OFFLINE","","EMERGENCY OPS:",""],[["DIAGNOSTICS",5],["SYNTHESIZE",6]],0,"a"],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," OFFLINE",""," PROBLEM:","  6 CAPS BLOWN","","SYNTHESIZE:"," ONLINE"],[],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","","EMERGENCY OPS:",""],[["BASIC RATIONS",-1]],0,"a"],C([]),[1,["I should","investigate"]],[2,["Sleep?",""],[["Yes",11],["No",-1]],0,"g"],[1,["I'm not tired!"]],[4,0],[1,["I'm hungry!"]],[1,["You died"]],[1,["It's RANGER!","","RANGER is DEAD!","","Found keycard"]],[1,["It's locked!"]],[2,["It's locked!","","Use keycard?",""],[["Yes",17],["No",-1]],0,"g"],[4,1],[2,["Search ruins?","","1 hour",""],[["Yes",19],["No",-1]],0,"g"],[4,2],[2,["A computer",""],[["Use",21]],0,"g"],[4,3],[2,["A computer",""],[["Use",21],["Fix",23]],0,"g"],[4,4],[2,["RSOS v3.27","--------------------","MAIN MENU","","SYSTEM ONLINE","","OPS:",""],[["DIAGNOSTICS",5],["SYNTHESIZE",6]],0,"a"]],y=e=>{let t=L[0]()[6],n=L[0]()[7];c.className=t,c.width=c.height=160,3===n[0]&&(T(e),Y()),0===n[0]&&"s.png"===n[1]&&F.drawImage(G,0,0),1===n[0]&&M(n[1]),2===n[0]&&w(n),requestAnimationFrame(y)},O=(e="",t=0,n=0)=>F.drawImage($,8*(e.charCodeAt(0)-32),0,8,8,8*t,8*n,8,8),A=(e="",t=0,n=0)=>{for(let o=0;o<e.length;o++)O(e[o],t+o,n)},M=e=>{let t=~~((20-e.length)/2);for(let n=0;n<e.length;n++){let o=~~((20-e[n].length)/2);A(e[n],o,t+n)}},w=e=>{for(let t=0;t<e[1].length;t++)A(e[1][t],0,t);A("<X>",17,0);let t=e[1].length%2?1:0;for(let n=0;n<e[2].length;n++)A(`${n+1} ${n===e[3]?"<":" "}${e[2][n][0]}${n===e[3]?">":" "}`,0,2*n+e[1].length+t)},T=e=>{let t=~~(e/500)%2?0:1,n=L[0]()[8],o=L[0]()[7],s=o[3],l=o[1],h=o[2],r=o[4],c=o[5],g=o[6],u=L[0]()[2],a=L[0]()[0],f=L[0]()[4]>=18||L[0]()[4]<6;for(let e=0;e<9;e++)for(let o=0;o<9;o++){let i=l-4+o,p=h-4+e;let d=16*t;if(I([i,p])){let e=s[p][i];e&&(d=16*e)}if(F.drawImage(v,d,0,16,16,16*(o+1),16*(e+1),16,16),0===r&&f)for(let s=0;s<n.length;s++){let l=n[s],h=l[0],r=l[1],c=l[2];h===i&&r===p&&l[3]>0&&(d=16*(7+t)+16*c*2,F.drawImage(D,d,0,16,16,16*(o+1),16*(e+1),16,16))}4===o&&4===e&&(d=u?16*t+16*a*2:64,F.drawImage(D,d,0,16,16,16*(o+1),16*(e+1),16,16)),0===r&&i===c-2&&p===g&&F.drawImage(D,80,0,16,16,16*(o+1),16*(e+1),16,16),0===r&&i===c-1&&p===g&&F.drawImage(D,96,0,16,16,16*(o+1),16*(e+1),16,16)}},Y=()=>{let e=L[0]()[1],t=L[0]()[2],n=L[0]()[9],o=L[0]()[10],s=L[0]()[11];A(`RANGER DOWN ${L[2]()}`,2.5,.5),F.drawImage(v,256,0,16,16,0,0,16,16),A(`${t}`,t<10?.5:0,2),F.drawImage(v,240,0,16,16,0,32,16,16),A(`${e}`,e<10?.5:0,6),F.drawImage(v,624,0,16,16,0,64,16,16),A(`${n}`,n<10?.5:0,10),F.drawImage(v,656,0,16,16,0,96,16,16),A(`${o}`,o<10?.5:0,14),F.drawImage(v,640,0,16,16,0,128,16,16),A(`${s}`,s<10?.5:0,18)},F=c.getContext("2d");let $,v,D,G,L=(()=>{let e,t,o,s,h,r,c,g,f,i,p,S,m,y,O;let A=()=>{e=[],t=0,o=20,s=20,h=20,r=0,c=5,g=0,f=17,i=55,R[7]=C(e),S=[R[7],R[1],R[0]],p="",m=[],y=0,T()},M=()=>{S.pop(),S.length||A()},w=([e,t])=>{let o=n(2),s=n(2)+1,l=R[7],h=l[3][t][e],r=l[1],c=l[2];k(h)||d(m,[e,t])||r===e&&c===t||m.push([e,t,o,s])},T=()=>{for(;m.length<53;){let e=n(160),t=n(160);w([e,t])}},Y=()=>{let e=([e,t])=>{for(let n=0;n<m.length;n++){let o=m[n],s=o[0],l=o[1];if(o[3]>0&&e===s&&t===l)return 1}};for(let t=0;t<m.length;t++){let o=m[t],l=o[0],h=o[1],r=S[S.length-1],c=R[7],g=c[1],u=c[2],i=[l,h];if((f>=18||f<6)&&Math.random()<.66){let e=a([l,h],[g,u]);i[0]=e[0],i[1]=e[1]}else n(2)?i[0]=l+(n(3)-1):i[1]=h+(n(3)-1);let p=c[3][i[1]][i[0]];k(p)||e([i[0],i[1]])||g===i[0]&&u===i[1]||(o[0]=i[0],o[1]=i[1],i[0]<l&&(o[2]=1),i[0]>l&&(o[2]=0)),3===r[0]&&0===r[4]&&(f>=18||f<6)&&g===i[0]&&u===i[1]&&n(2)&&s>0&&o[3]>0&&s--}},F=()=>{if(s<1)S=[R[13]];else{if(60==++i&&(i=0,6==++f&&(p="",S.push(R[2])),18===f&&(p="i",S.push(R[3])),o>0?(o--,s<h&&s++):(s--,S.push(R[12]))),24===f){f=0;let e=R[7];for(let t=0;t<160;t++)for(let n=0;n<160;n++)if(36===e[3][t][n]){let e=l([n,t]);for(let t=0;t<e.length;t++)w(e[t])}}Y()}},$=[()=>{for(;5!==f||59!==i;)60==++i&&(i=0,f++,s<h&&s++),24===f&&(f=0),Y()},()=>{O[0]=1,r--},()=>{for(let e=0;e<60;e++)F();if(s>0){let e=n(16);if(e<2){let e=n(3)+1;S.push([1,[`Found ${e} food`]]),o+=e}else e<4?(S.push([1,["Found keycard"]]),r++):e<6?(S.push([1,["Found caps"]]),c++):e<8?(S.push([1,["Found backup"]]),g++):e<9?(S.push([1,["Rocks fell!","","Lost health"]]),s--):S.push([1,["Found nothing"]])}},()=>{O[1]?S.push(R[24]):S.push(R[4])},()=>{S.push([1,["Replaced 6 caps"]]),c-=6,O[1]=1}];return A(),[()=>[t,o,s,h,f,i,(()=>0===S[S.length-1][0]?"g":1===S[S.length-1][0]?"g":2===S[S.length-1][0]?S[S.length-1][4]:p)(),S[S.length-1],m,r,c,g],A,()=>`${f<10?"0":""}${f}:${i<10?"0":""}${i}`,F,(o,l)=>{let h=S[S.length-1];if(3!==h[0])return;let g;if(F(),-1===o&&(t=1),1===o&&(t=0),o=h[1]+o,l=h[2]+l,(f>=18||f<6)&&0===h[4])for(let e=0;e<m.length;e++)m[e][0]===o&&m[e][1]===l&&m[e][3]>0&&(g=m[e]);s>0&&I([o,l])&&!k(h[3][l][o])&&!g&&(h[1]=o,h[2]=l),0===h[4]&&(20===h[3][l][o]&&((O=e[160*l+o])[0]?S.push((()=>{let e=N(),t=u([0,0],([t,n])=>1===e[n][t]);return E(e,t,()=>27),e[19][18]=21,e[19][19]=22,e[19][20]=23,e[20][18]=2,e[20][19]=2,e[20][20]=2,e[21][18]=24,e[21][19]=25,e[21][20]=26,[3,20,20,e,1,20,20]})()):r?S.push(R[16]):S.push(R[15])),l===h[6]&&o===h[5]-1&&S.push(R[8]),g&&n(2)&&g[3]--,38!==h[3][l][o]||y||(y=1,S.push(R[14]),r++),h[3][l][o]>=28&&h[3][l][o]<31&&S.push(R[18])),1===h[4]&&(26===h[3][l][o]&&S.pop(),21===h[3][l][o]&&(!O[1]&&c>=6?S.push(R[22]):S.push(R[20])),23===h[3][l][o]&&(f>=18||f<6?S.push(R[9]):S.push(R[10])))},M,e=>{2===S[S.length-1][0]&&(S[S.length-1][3]=e)},()=>{if(2===S[S.length-1][0]){let e=S[S.length-1];if(!e[2].length)return void S.pop();let t=e[3],n=e[2][t][1];-1===n?M():4===R[n][0]?(S.pop(),$[R[n][1]]()):S.push(R[n])}}]})();document.onkeyup=(e=>{let t=L[0]()[7];if(3===t[0]&&(e=>{65!==e.keyCode&&37!==e.keyCode||L[4](-1,0),68!==e.keyCode&&39!==e.keyCode||L[4](1,0),87!==e.keyCode&&38!==e.keyCode||L[4](0,-1),83!==e.keyCode&&40!==e.keyCode||L[4](0,1)})(e),0!==t[0]&&1!==t[0]||32!==e.keyCode&&27!==e.keyCode&&13!==e.keyCode||L[5](),2===t[0]){let n=t;27===e.keyCode&&L[5](),87!==e.keyCode&&38!==e.keyCode||n[3]>0&&L[6](n[3]-1),83!==e.keyCode&&40!==e.keyCode||n[3]<n[2].length-1&&L[6](n[3]+1),32!==e.keyCode&&13!==e.keyCode||L[7]()}});let B=([e,t])=>{let n=L[0]()[7],s=c.getBoundingClientRect().width/10,l=~~((e-c.getBoundingClientRect().left)/s)-1,h=~~((t-c.getBoundingClientRect().top)/s)-1;if(3===n[0]){if(4===l&&4===h)return;if(l<0||h<0)return;let e=o(l,4),t=o(h,4);let n=0,s=0;e>t?n=l>4?1:-1:e<t&&(s=h>4?1:-1),L[4](n,s)}if(0!==n[0]&&1!==n[0]||L[5](),2===n[0]){h<0&&L[5]();let e=n,t=e[1].length%2?1:0,o=(e[1].length+t)/2,s=e[2].length,l=h-o+1;l>=0&&l<s&&(l===e[3]?L[7]():L[6](l))}};c.ontouchend=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)B([e.changedTouches[t].clientX,e.changedTouches[t].clientY])}),c.onclick=(e=>{e.preventDefault(),B([e.clientX,e.clientY])}),((...t)=>Promise.all(t.map(e)))("f.gif","t.gif","p.gif","s.png").then(e=>{[$,v,D,G]=e,requestAnimationFrame(y)})};s();