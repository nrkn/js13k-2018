let s=()=>{let e=e=>new Promise(t=>{let o=new Image;o.onload=(()=>t(o)),o.src=e}),t=e=>e[o(e.length)],o=(e,t=0)=>~~(Math.random()*e)+t,n=e=>e.slice().sort(()=>o(3)-1),s=(e,t)=>Math.max(e,t)-Math.min(e,t),r=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]],l=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1],[e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]],h=(e,t,o)=>r(t).filter(t=>e[t[1]][t[0]]===o),a=([e,t],[o,n])=>Math.hypot(s(e,o),s(t,n)),g=(e,t)=>{let o,n=25600;for(let s=0;s<t.length;s++){let r=a(e,t[s]);r<n&&(n=r,o=t[s])}return o},i=([e,t],o)=>{let n=[],s=[[e,t,0]],l=[],h=([e,t,h])=>{E([e,t])&&o([e,t])&&(l[160*t+e]||(n.push([e,t,h]),l[160*t+e]=1,s.push(...r([e,t]).map(([e,t])=>[e,t,h+1]))))};for(;s.length;)h(s.shift());return n},u=([e,t],[o,n])=>{let r=s(e,o),l=s(t,n),h=e,a=t;return r>l&&(o>e&&(h=e+1),e>o&&(h=e-1)),l>r&&(n>t&&(a=t+1),t>n&&(a=t-1)),[h,a]},p=([e,o],[n,s],l=E,h=.66)=>{let a=[],c=[],g=([e,o])=>{c[160*o+e]||(a.push([e,o]),c[160*o+e]=1),e===n&&o===s||g(Math.random()<h?t(r([e,o]).filter(l))||[e,o]:u([e,o],[n,s]))};return g([e,o]),a},S=e=>[3===e?20:1===e?140:o(120,20),0===e?20:2===e?140:o(120,20)],f=()=>[o(120,20),o(120,20)],R=(e,[t,o])=>{for(let n=0;n<e.length;n++)if(e[n][0]===t&&e[n][1]===o)return!0;return!1},E=([e,t])=>e>=0&&e<=159&&t>=0&&t<=159,d=([e,t])=>e>=8&&e<=152&&t>=8&&t<=152,N=()=>{let e=[];for(let t=0;t<160;t++){let t=[];for(let e=0;e<160;e++)t.push(1);e.push(t)}return e},I=(e,t,o)=>{for(let n=0;n<t.length;n++){let[s,r]=t[n];e[r][s]=o([s,r])}},m=(e,s)=>{let c=N(),u=o(10,40),R=[S(0),S(1),S(2),S(3)];for(;R.length<u;){let e=f(),t=g(e,R);a(e,t)>10&&R.push(e)}let E=[],m=R.slice();let O=m.pop();let T=O;for(;m.length;){let e=g(O,m),t=p(O,e,d,.33);E.push(...t),O=m.pop()}let y=p(O,T,d,.33);E.push(...y);for(let e=0;e<10;e++){let e=p(t(R),t(R),d,.33);E.push(...e)}let C=[];for(let e=0;e<R.length;e++)C.push(...l(R[e]));let w=((e,o=8448)=>{let n=e.slice(),s=[];for(let e=0;e<n.length;e++){let[t,o]=n[e];s[160*o+t]=1}for(;n.length<o;){let[e,o]=t(n),l=r([e,o]);if(l.length){let[e,o]=t(l);s[160*o+e]||(n.push([e,o]),s[160*o+e]=1)}}return n})((e=>{let t=[],o=[];for(let n=0;n<e.length;n++){let[s,r]=e[n];o[160*r+s]||(t.push(e[n]),o[160*r+s]=1)}return console.log("unique",e.length,t.length),t})([...R,...C,...E])),[M,A]=(e=>{let t=160,o=[0,0];for(let n=0;n<e.length;n++){let[s,r]=e[n];s<t&&(t=s,o=[s,r])}return o})(w);I(c,w,()=>2);let F=i([0,0],([e,t])=>1===c[t][e]);I(c,F,()=>0);let Y=((e,t)=>t.slice().sort((t,o)=>a(e,t)-a(e,o)))([M,A],R),k=p([M,A],Y[0],d,.33);E.push(...k),(e=>{let t=0;let s=n([0,3,6,9]);for(let n=0;n<160;n++)for(let r=0;r<160;r++)if(1===e[n][r]){let l=i([r,n],([t,o])=>1===e[o][t]);let h=0;l.length>5&&(h=t<4?s[t]:o(10),t++),I(e,l,h<3?()=>o(9)+2:h<6?()=>o(3)?o(4)+11:o(9)+2:h<9?()=>o(4)?o(3)+31:o(9)+2:()=>0)}})(c),(e=>{for(let t=0;t<160;t++)for(let n=0;n<160;n++)2===e[t][n]&&(h(e,[n,t],0).length?e[t][n]=o(3)+17:e[t][n]=o(13)+2)})(c),I(c,E,([e,t])=>c[t][e]>=17&&c[t][e]<20?c[t][e]:2),I(c,C,([e,t])=>c[t][e]>=17&&c[t][e]<20?c[t][e]:o(9)+2);for(let t=0;t<Y.length;t++){let[n,r]=Y[t],l=o(10);0===t?c[r][n]=38:1===t?(c[r][n]=20,e[160*r+n]=[0,0],e[0].push([n,r])):2===t?(c[r][n]=o(3)+28,s[160*r+n]=[],s[0].push([n,r])):t===Y.length-1?c[r][n]=34:l<6?(c[r][n]=o(3)+28,s[160*r+n]=[],s[0].push([n,r])):l<9?(c[r][n]=20,e[160*r+n]=[0,0],e[0].push([n,r])):c[r][n]=36}return[3,M,A,c,0,M,A]},O=e=>e<2||e>=11&&e<15||20===e||27===e||24===e||25===e||26===e||21===e||22===e||23===e||e>=28&&e<31||e>=31&&e<34,T=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","--------------------","MAIN MENU","","ERROR:"," MAIN SYSTEM OFFLINE","","EMERGENCY OPS:",""],[["DIAGNOSTICS",5],["SYNTHESIZE",27]],0,"a"],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," OFFLINE","  6 BAD CHIPS","SYNTHESIZE:"," ONLINE","  DB ERRORS","COMMS:"," OFFLINE","  UNKNOWN ERROR","SECURITY:"," OFFLINE","  DB ERRORS","MAP:"," OFFLINE","  DB ERRORS"],[],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","  USE RESTORE DISK","POWER:"," FULL","","EMERGENCY OPS:",""],[["BASIC RATIONS",26]],0,"a"],[3,0,0,[[]],0,0,0],[1,["I should","investigate"]],[2,["Sleep?",""],[["Yes",11],["No",-1]],0,"g"],[1,["I'm not tired!"]],[4,0],[1,["I'm hungry!"]],[1,["You died"]],[1,["It's RANGER!","","RANGER is DEAD!","","Found keycard"]],[1,["It's locked!"]],[2,["It's locked!","","Use keycard?",""],[["Yes",17],["No",-1]],0,"g"],[4,1],[2,["Search ruins?","","1 hour",""],[["Yes",19],["No",-1]],0,"g"],[4,2],[2,["A computer",""],[["Use",21]],0,"g"],[4,3],[2,["A computer",""],[["Use",21],["Fix Chips",23],["Restore Backups",41]],0,"g"],[4,4],[2,["RSOS v3.27","--------------------","MAIN MENU","","OPS:",""],[["DIAGNOSTICS",32],["SYNTHESIZE",6],["NOTES",28],["COMMS",29],["SECURITY",30],["MAP",31]],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","  USE RESTORE DISK","POWER:"," CHARGING",""],[],0,"a"],[4,5],[4,6],[4,7],[4,8],[4,9],[4,10],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," ONLINE","SYNTHESIZE:"," ONLINE","  DB ERRORS","COMMS:"," OFFLINE","  UNKNOWN ERROR","SECURITY:"," OFFLINE","  DB ERRORS","MAP:"," OFFLINE","  DB ERRORS"],[],0,"a"],[2,["RSOS v3.27","--------------------","NOTES ENTRY 1","","USER: RANGER","","Sent to investigate","ruins. Found strange","technology"],[],0,"a"],[2,["RSOS v3.27","--------------------","NOTES ENTRY 2","","USER: RANGER","","Was testing strange","technology. Portals","appeared!"],[],0,"a"],[2,["RSOS v3.27","--------------------","NOTES ENTRY 3","","USER: RANGER","","Monsters coming out","of portals! Made it","back to hut. They","only come out at","night"],[],0,"a"],[2,["RSOS v3.27","--------------------","NOTES ENTRY 4","","USER: RANGER","","Monsters affecting","computers. Have been","stashing items in","ruins for emergency.","Tried comms but the","satellite is offline"],[],0,"a"],[2,["RSOS v3.27","--------------------","NOTES ENTRY 5","","USER: RANGER","","Found way to use","synth to alter chip","to shut down portal","but computer went","offline! There are","more of them every","night"],[],0,"a"],[2,["RSOS v3.27","--------------------","NOTES ENTRY 6","","USER: RANGER","","Got computer online.","Still has errors.","Security system","should be able to","deal with monsters","if can get it online"],[],0,"a"],[2,["RSOS v3.27","--------------------","NOTES ENTRY 7","","USER: RANGER","","Comms damaged beyond","repair but can send","a distress signal if","repair the satellite","transmitter with","some chips. Not sure","where the dish is","on island and maps","are offline"],[],0,"a"],[2,["RSOS v3.27","--------------------","NOTES ENTRY 8","","USER: RANGER","","No way to warn","rescue team of","monsters with comms","offline. Can't send","distress signal","until deal with","monsters!"],[],0,"a"],[4,11]],y=e=>{let t=B[0]()[6],o=B[0]()[7];c.className=t,c.width=c.height=160,3===o[0]&&(F(e),Y()),0===o[0]&&"s.png"===o[1]&&U.drawImage($,0,0),1===o[0]&&M(o[1]),2===o[0]&&A(o),5===o[0]&&k(),requestAnimationFrame(y)},C=(e="",t=0,o=0)=>U.drawImage(v,8*(e.charCodeAt(0)-32),0,8,8,8*t,8*o,8,8),w=(e="",t=0,o=0)=>{for(let n=0;n<e.length;n++)C(e[n],t+n,o)},M=e=>{let t=~~((20-e.length)/2);for(let o=0;o<e.length;o++){let n=~~((20-e[o].length)/2);w(e[o],n,t+o)}},A=e=>{for(let t=0;t<e[1].length;t++)w(e[1][t],0,t);w("<X>",17,0);let t=e[1].length%2?1:0;for(let o=0;o<e[2].length;o++)w(`${o+1} ${o===e[3]?"<":" "}${e[2][o][0]}${o===e[3]?">":" "}`,0,2*o+e[1].length+t)},F=e=>{let t=~~(e/500)%2?0:1,o=B[0]()[8],n=B[0]()[7],s=n[3],r=n[1],l=n[2],h=n[4],a=n[5],c=n[6],g=B[0]()[2],i=B[0]()[0],u=B[0]()[12],p=B[0]()[4]>=18||B[0]()[4]<6;for(let e=0;e<9;e++)for(let n=0;n<9;n++){let S=r-4+n,f=l-4+e;let R=16*t;if(E([S,f])){let e=s[f][S];e&&(R=16*e)}if(U.drawImage(D,R,0,16,16,16*(n+1),16*(e+1),16,16),0===h&&p)for(let s=0;s<o.length;s++){let r=o[s],l=r[0],h=r[1],a=r[2];l===S&&h===f&&r[3]>0&&(R=16*(7+t)+16*a*2,U.drawImage(G,R,0,16,16,16*(n+1),16*(e+1),16,16))}4===n&&4===e&&(R=g?16*t+16*i*2:64,U.drawImage(G,R,0,16,16,16*(n+1),16*(e+1),16,16)),0===h&&S===a-2&&f===c&&U.drawImage(G,80,0,16,16,16*(n+1),16*(e+1),16,16),0===h&&S===a-1&&f===c&&U.drawImage(G,96,0,16,16,16*(n+1),16*(e+1),16,16),0!==h||u[160*f+S]||U.drawImage(D,672,0,16,16,16*(n+1),16*(e+1),16,16)}},Y=()=>{let e=B[0]()[1],t=B[0]()[2],o=B[0]()[9],n=B[0]()[10],s=B[0]()[11];w(`RANGER DOWN ${B[2]()}`,2.5,.5),U.drawImage(D,256,0,16,16,0,0,16,16),w(`${t}`,t<10?.5:0,2),U.drawImage(D,240,0,16,16,0,32,16,16),w(`${e}`,e<10?.5:0,6),U.drawImage(D,624,0,16,16,0,64,16,16),w(`${o}`,o<10?.5:0,10),U.drawImage(D,656,0,16,16,0,96,16,16),w(`${n}`,n<10?.5:0,14),U.drawImage(D,640,0,16,16,0,128,16,16),w(`${s}`,s<10?.5:0,18)},k=()=>{let e=B[0]()[7],t=B[0]()[12],o=e[1],n=e[1],s=e[3],r=e[4];for(let e=0;e<160;e++)for(let o=0;o<160;o++){let n=~~(o/32),l=~~(e/32),h=s[e][o],a=h>=17&&h<20;r[5*l+n]?0===h||!t[160*e+o]&&!a?U.drawImage(D,432,0,1,1,o,e,1,1):U.drawImage(D,32,0,1,1,o,e,1,1):o>8&&e>8&&(o%2&&!(e%2)||!(o%2)&&e%2)&&U.drawImage(D,32,0,1,1,o,e,1,1)}for(let e=0;e<160;e++)for(let t=0;t<160;t++){let l=~~(t/32),h=~~(e/32),a=s[e][t];r[5*h+l]&&(20===a&&U.drawImage(L,0,0,7,7,t-3,e-3,7,7),a>=28&&a<31&&U.drawImage(L,7,0,7,7,t-3,e-3,7,7),34===a&&U.drawImage(L,14,0,7,7,t-3,e-3,7,7),t===o&&e===n&&U.drawImage(L,21,0,7,7,t-3,e-3,7,7))}for(let e=0;e<32;e++)U.drawImage(v,8*(16+e),0,8,8,0,32*e+16,8,8);for(let e=0;e<32;e++)U.drawImage(v,8*(33+e),0,8,8,32*e+16,0,8,8)},U=c.getContext("2d");let v,D,G,$,L,B=(()=>{let e,s,r,h,c,g,p,S,f,d,y,C,w,M,A,F,Y,k,U,v,D;let G=()=>{e=[[]],s=[[]],r=0,h=20,c=99,g=99,p=0,S=5,f=0,d=17,y=55,T[7]=m(e,s),w=[T[7],T[1],T[0]],C="",M=[],F=0,U=0,v=[33],D=[],A=[];let t=T[7],o=t[1],n=t[2];D[5*~~(n/32)+~~(o/32)]=1,B(),b(),H(t)},$=()=>{w.pop(),w.length||G()},L=([e,t])=>{let n=o(2),s=o(2)+1,r=T[7],l=r[3][t][e],h=r[1],a=r[2];O(l)||R(M,[e,t])||h===e&&a===t||M.push([e,t,n,s])},B=()=>{for(;M.length<8;){let e=o(160),t=o(160);L([e,t])}},b=()=>{let o=e[0].length,r=~~(2*o),l=~~(9*o),h=~~(2*o);let a=[];for(let e=0;e<r;e++)a.push(0);for(let e=0;e<l;e++)a.push(1);for(let e=0;e<50;e++)a.push(2);for(let e=0;e<h;e++)a.push(3);for(a=n(a);a.length;){let e=a.pop(),[o,n]=t(s[0]);s[160*n+o].push(e)}},P=(e=0)=>{if(c<1)w=[T[13]];else{if(60==++y&&(y=0,d++,e?(c<g&&c++,6===d&&(C="")):(6===d&&(C="",w.push(T[2])),18===d&&(C="i",w.push(T[3])),h>0?(h--,c<g&&c++):(c--,w.push(T[12])))),24===d){U=0,d=0;let e=T[7];for(let t=0;t<160;t++)for(let n=0;n<160;n++)if(36===e[3][t][n]){let e=l([n,t]);for(let t=0;t<e.length;t++)o(3)||L(e[t])}}(()=>{let e=([e,t])=>{for(let o=0;o<M.length;o++){let n=M[o],s=n[0],r=n[1];if(n[3]>0&&e===s&&t===r)return 1}};for(let t=0;t<M.length;t++){let n=M[t],s=n[0],r=n[1],l=w[w.length-1],h=T[7],a=h[1],g=h[2],i=[s,r];if((d>=18||d<6)&&Math.random()<.66){let e=u([s,r],[a,g]);i[0]=e[0],i[1]=e[1]}else o(2)?i[0]=s+(o(3)-1):i[1]=r+(o(3)-1);let p=h[3][i[1]][i[0]];O(p)||e([i[0],i[1]])||a===i[0]&&g===i[1]||(n[0]=i[0],n[1]=i[1],i[0]<s&&(n[2]=1),i[0]>s&&(n[2]=0)),3===l[0]&&0===l[4]&&(d>=18||d<6)&&a===i[0]&&g===i[1]&&o(2)&&c>0&&n[3]>0&&c--}})()}},H=e=>{if(0===e[4]){let t=e[1],o=e[2];for(let e=-4;e<4;e++)for(let n=-4;n<4;n++){let s=t+n,r=o+e;a([t,o],[s,r])<4&&(A[160*r+s]=1)}}},W=[()=>{for(;6!==d;)P(1)},()=>{Y[0]=1,p--},()=>{if(k.length){for(let e=0;e<60;e++)P();let e=k.pop();if(3===e){let e=o(3)+1;w.push([1,[`Found ${e} food`]]),h+=e}else 0===e?(w.push([1,["Found keycard"]]),p++):1===e?(w.push([1,["Found chip"]]),S++):2===e&&(w.push([1,["Found backup"]]),f++)}else w.push([1,["Found nothing"]])},()=>{Y[1]?w.push(T[24]):w.push(T[4])},()=>{w.push([1,["Replaced 6 chips"]]),S-=6,Y[1]=1},()=>{let e=o(3)+6;U=1,h+=e,w.push([1,[`Synthesized ${e} food`]])},()=>{U?w.push(T[25]):w.push(T[6])},()=>{let e=[2,["RSOS v3.27","--------------------","NOTES MENU"],v.map(e=>[`ENTRY ${e}`,e]),0,"a"];w.push(e)},()=>{},()=>{},()=>{let e=T[7],t=e[1],o=e[2],n=[5,t,o,e[3],D];console.log("showing map",{playerX:t,playerY:o}),w.push(n)},()=>{f--;let e=v.length+33;if(o(8)<2&&e<41)v.push(e),w.push([1,["Recovered 1 note","database entry"]]);else{let e=[];for(let t=0;t<5;t++)for(let o=0;o<5;o++)D[5*t+o]||e.push([o,t]);if(e.length){let[o,n]=t(e);D[5*n+o]=1,w.push([1,["Recovered 1 map","database entry"]])}else w.push([1,["Disk corrupt"]])}}];return G(),[()=>[r,h,c,g,d,y,(()=>0===w[w.length-1][0]?"g":1===w[w.length-1][0]?"g":5===w[w.length-1][0]?"a":2===w[w.length-1][0]?w[w.length-1][4]:C)(),w[w.length-1],M,p,S,f,A],G,()=>`${d<10?"0":""}${d}:${y<10?"0":""}${y}`,P,(t,n)=>{let l=w[w.length-1];if(3!==l[0])return;let h;if(P(),-1===t&&(r=1),1===t&&(r=0),t=l[1]+t,n=l[2]+n,(d>=18||d<6)&&0===l[4])for(let e=0;e<M.length;e++)M[e][0]===t&&M[e][1]===n&&M[e][3]>0&&(h=M[e]);if(c>0&&E([t,n])&&!O(l[3][n][t])&&!h&&(l[1]=t,l[2]=n),H(l),0===l[4]&&(20===l[3][n][t]&&((Y=e[160*n+t])[0]?w.push((()=>{let e=N(),t=i([0,0],([t,o])=>1===e[o][t]);return I(e,t,()=>27),e[19][18]=21,e[19][19]=22,e[19][20]=23,e[20][18]=2,e[20][19]=2,e[20][20]=2,e[21][18]=24,e[21][19]=25,e[21][20]=26,[3,20,20,e,1,20,20]})()):p?w.push(T[16]):w.push(T[15])),n===l[6]&&t===l[5]-1&&w.push(T[8]),h&&o(2)&&h[3]--,38!==l[3][n][t]||F||(F=1,w.push(T[14]),p++),l[3][n][t]>=28&&l[3][n][t]<31&&(k=s[160*n+t],w.push(T[18]))),1===l[4]){if(26===l[3][n][t]&&w.pop(),21===l[3][n][t]){let e=T[22].slice();e[2]=e[2].filter((e,t)=>1===t&&Y[1]?0:1===t&&S<6?0:2!==t||Y[1]?2===t&&f<1?0:1:0),w.push(e)}23===l[3][n][t]&&(d>=18||d<6?w.push(T[9]):w.push(T[10]))}},$,e=>{2===w[w.length-1][0]&&(w[w.length-1][3]=e)},()=>{if(2===w[w.length-1][0]){let e=w[w.length-1];if(!e[2].length)return void w.pop();let t=e[3],o=e[2][t][1];-1===o?$():4===T[o][0]?(w.pop(),W[T[o][1]]()):w.push(T[o])}}]})();document.onkeyup=(e=>{let t=B[0]()[7];if(3===t[0]&&(e=>{65!==e.keyCode&&37!==e.keyCode||B[4](-1,0),68!==e.keyCode&&39!==e.keyCode||B[4](1,0),87!==e.keyCode&&38!==e.keyCode||B[4](0,-1),83!==e.keyCode&&40!==e.keyCode||B[4](0,1)})(e),0!==t[0]&&1!==t[0]&&5!==t[0]||32!==e.keyCode&&27!==e.keyCode&&13!==e.keyCode||B[5](),2===t[0]){let o=t;27===e.keyCode&&B[5](),87!==e.keyCode&&38!==e.keyCode||o[3]>0&&B[6](o[3]-1),83!==e.keyCode&&40!==e.keyCode||o[3]<o[2].length-1&&B[6](o[3]+1),32!==e.keyCode&&13!==e.keyCode||B[7]()}});let b=([e,t])=>{let o=B[0]()[7],n=c.getBoundingClientRect().width/10,r=~~((e-c.getBoundingClientRect().left)/n)-1,l=~~((t-c.getBoundingClientRect().top)/n)-1;if(3===o[0]){if(4===r&&4===l)return;if(r<0||l<0)return;let e=s(r,4),t=s(l,4);let o=0,n=0;e>t?o=r>4?1:-1:e<t&&(n=l>4?1:-1),B[4](o,n)}if(0!==o[0]&&1!==o[0]&&5!==o[0]||B[5](),2===o[0]){l<0&&B[5]();let e=o,t=e[1].length%2?1:0,n=(e[1].length+t)/2,s=e[2].length,r=l-n+1;r>=0&&r<s&&(r===e[3]?B[7]():B[6](r))}};c.ontouchend=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)b([e.changedTouches[t].clientX,e.changedTouches[t].clientY])}),c.onclick=(e=>{e.preventDefault(),b([e.clientX,e.clientY])}),((...t)=>Promise.all(t.map(e)))("f.gif","t.gif","p.gif","s.png","c.gif").then(e=>{[v,D,G,$,L]=e,requestAnimationFrame(y)})};s();