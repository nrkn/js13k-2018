let s=()=>{let e=e=>new Promise(t=>{let n=new Image;n.onload=(()=>t(n)),n.src=e}),t=e=>e[n(e.length)],n=(e,t=0)=>~~(Math.random()*e)+t,o=(e,t)=>Math.max(e,t)-Math.min(e,t),s=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]],r=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1],[e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]],l=(e,t,n)=>s(t).filter(t=>e[t[1]][t[0]]===n),h=([e,t],[n,s])=>Math.hypot(o(e,n),o(t,s)),a=(e,t)=>{let n,o=25600;for(let s=0;s<t.length;s++){let r=h(e,t[s]);r<o&&(o=r,n=t[s])}return n},g=([e,t],n)=>{let o=[],r=[[e,t,0]],l=[],h=([e,t,h])=>{d([e,t])&&n([e,t])&&(l[160*t+e]||(o.push([e,t,h]),l[160*t+e]=1,r.push(...s([e,t]).map(([e,t])=>[e,t,h+1]))))};for(;r.length;)h(r.shift());return o},i=([e,t],[n,s])=>{let r=o(e,n),l=o(t,s),h=e,a=t;return r>l&&(n>e&&(h=e+1),e>n&&(h=e-1)),l>r&&(s>t&&(a=t+1),t>s&&(a=t-1)),[h,a]},u=([e,n],[o,r],l=d,h=.66)=>{let a=[],c=[],g=([e,n])=>{c[160*n+e]||(a.push([e,n]),c[160*n+e]=1),e===o&&n===r||g(Math.random()<h?t(s([e,n]).filter(l))||[e,n]:i([e,n],[o,r]))};return g([e,n]),a},S=e=>[3===e?20:1===e?140:n(120,20),0===e?20:2===e?140:n(120,20)],R=()=>[n(120,20),n(120,20)],E=(e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return!0;return!1},d=([e,t])=>e>=0&&e<=159&&t>=0&&t<=159,f=([e,t])=>e>=8&&e<=152&&t>=8&&t<=152,p=()=>{let e=[];for(let t=0;t<160;t++){let t=[];for(let e=0;e<160;e++)t.push(1);e.push(t)}return e},N=(e,t,n)=>{for(let o=0;o<t.length;o++){let[s,r]=t[o];e[r][s]=n([s,r])}},I=e=>{let t=0;let o=(e=>e.slice().sort(()=>n(3)-1))([0,3,6,9]);for(let s=0;s<160;s++)for(let r=0;r<160;r++)if(1===e[s][r]){let l=g([r,s],([t,n])=>1===e[n][t]);let h=0;l.length>5&&(h=t<4?o[t]:n(10),t++),N(e,l,h<3?()=>n(9)+2:h<6?()=>n(3)?n(4)+11:n(9)+2:h<9?()=>n(4)?n(3)+31:n(9)+2:()=>0)}},m=e=>{let o=p(),c=n(10,40),i=[S(0),S(1),S(2),S(3)];for(;i.length<c;){let e=R(),t=a(e,i);h(e,t)>10&&i.push(e)}let E=[],d=i.slice();let m=d.pop();let A=m;for(;d.length;){let e=a(m,d),t=u(m,e,f,.33);E.push(...t),m=d.pop()}let O=u(m,A,f,.33);E.push(...O);for(let e=0;e<10;e++){let e=u(t(i),t(i),f,.33);E.push(...e)}let T=[];for(let e=0;e<i.length;e++)T.push(...r(i[e]));let C=((e,n=8448)=>{let o=e.slice(),r=[];for(let e=0;e<o.length;e++){let[t,n]=o[e];r[160*n+t]=1}for(;o.length<n;){let[e,n]=t(o),l=s([e,n]);if(l.length){let[e,n]=t(l);r[160*n+e]||(o.push([e,n]),r[160*n+e]=1)}}return o})((e=>{let t=[],n=[];for(let o=0;o<e.length;o++){let[s,r]=e[o];n[160*r+s]||(t.push(e[o]),n[160*r+s]=1)}return console.log("unique",e.length,t.length),t})([...i,...T,...E])),[y,w]=(e=>{let t=160,n=[0,0];for(let o=0;o<e.length;o++){let[s,r]=e[o];s<t&&(t=s,n=[s,r])}return n})(C);N(o,C,()=>2);let M=g([0,0],([e,t])=>1===o[t][e]);N(o,M,()=>0);let F=((e,t)=>t.slice().sort((t,n)=>h(e,t)-h(e,n)))([y,w],i),Y=u([y,w],F[0],f,.33);E.push(...Y),I(o),(e=>{for(let t=0;t<160;t++)for(let o=0;o<160;o++)2===e[t][o]&&(l(e,[o,t],0).length?e[t][o]=n(3)+17:e[t][o]=n(13)+2)})(o),N(o,E,([e,t])=>o[t][e]>=17&&o[t][e]<20?o[t][e]:2),N(o,T,([e,t])=>o[t][e]>=17&&o[t][e]<20?o[t][e]:n(9)+2);for(let t=0;t<F.length;t++){let[s,r]=F[t],l=n(10);0===t?o[r][s]=38:1===t?(o[r][s]=20,e[160*r+s]=[0,0]):2===t?o[r][s]=n(3)+28:t===F.length-1?o[r][s]=34:l<6?o[r][s]=n(3)+28:l<9?(o[r][s]=20,e[160*r+s]=[0,0]):o[r][s]=36}return[3,y,w,o,0,y,w]},A=e=>e<2||e>=11&&e<15||20===e||27===e||24===e||25===e||26===e||21===e||22===e||23===e||e>=28&&e<31||e>=31&&e<34,O=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","--------------------","MAIN MENU","","ERROR:"," MAIN SYSTEM OFFLINE","","EMERGENCY OPS:",""],[["DIAGNOSTICS",5],["SYNTHESIZE",27]],0,"a"],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," OFFLINE","  6 BAD CHIPS","SYNTHESIZE:"," ONLINE","  DB ERRORS","COMMS:"," OFFLINE","  UNKNOWN ERROR","SECURITY:"," OFFLINE","  DB ERRORS","MAP:"," OFFLINE","  DB ERRORS"],[],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","  USE RESTORE DISK","POWER:"," FULL","","EMERGENCY OPS:",""],[["BASIC RATIONS",26]],0,"a"],[3,0,0,[[]],0,0,0],[1,["I should","investigate"]],[2,["Sleep?",""],[["Yes",11],["No",-1]],0,"g"],[1,["I'm not tired!"]],[4,0],[1,["I'm hungry!"]],[1,["You died"]],[1,["It's RANGER!","","RANGER is DEAD!","","Found keycard"]],[1,["It's locked!"]],[2,["It's locked!","","Use keycard?",""],[["Yes",17],["No",-1]],0,"g"],[4,1],[2,["Search ruins?","","1 hour",""],[["Yes",19],["No",-1]],0,"g"],[4,2],[2,["A computer",""],[["Use",21]],0,"g"],[4,3],[2,["A computer",""],[["Use",21],["Fix",23]],0,"g"],[4,4],[2,["RSOS v3.27","--------------------","MAIN MENU","","OPS:",""],[["DIAGNOSTICS",32],["SYNTHESIZE",6],["DATABASE",28],["COMMS",29],["SECURITY",30],["MAP",31]],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","  USE RESTORE DISK","POWER:"," CHARGING",""],[],0,"a"],[4,5],[4,6],[4,7],[4,8],[4,9],[4,10],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," ONLINE","SYNTHESIZE:"," ONLINE","  DB ERRORS","COMMS:"," OFFLINE","  UNKNOWN ERROR","SECURITY:"," OFFLINE","  DB ERRORS","MAP:"," OFFLINE","  DB ERRORS"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 1","","USER: RANGER","","Sent to investigate","ruins. Found strange","technology"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 2","","USER: RANGER","","Was testing strange","technology. Portals","appeared!"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 3","","USER: RANGER","","Monsters coming out","of portals! Made it","back to hut. They","only come out at","night"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 4","","USER: RANGER","","Monsters affecting","computers. Have been","stashing items in","ruins for emergency.","Tried comms but the","satellite is offline"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 5","","USER: RANGER","","Found way to use","synth to alter chip","to shut down portal","but computer went","offline! There are","more of them every","night"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 6","","USER: RANGER","","Got computer online.","Still has errors.","Security system","should be able to","deal with monsters","if can get it online"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 7","","USER: RANGER","","Comms damaged beyond","repair but can send","a distress signal if","repair the satellite","transmitter with","some chips. Not sure","where the dish is","on island and maps","are offline"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 8","","USER: RANGER","","No way to warn","rescue team of","monsters with comms","offline. Can't send","distress signal","until deal with","monsters!"],[],0,"a"]],T=e=>{let t=$[0]()[6],n=$[0]()[7];c.className=t,c.width=c.height=160,3===n[0]&&(F(e),Y()),0===n[0]&&"s.png"===n[1]&&D.drawImage(G,0,0),1===n[0]&&w(n[1]),2===n[0]&&M(n),5===n[0]&&k(),requestAnimationFrame(T)},C=(e="",t=0,n=0)=>D.drawImage(U,8*(e.charCodeAt(0)-32),0,8,8,8*t,8*n,8,8),y=(e="",t=0,n=0)=>{for(let o=0;o<e.length;o++)C(e[o],t+o,n)},w=e=>{let t=~~((20-e.length)/2);for(let n=0;n<e.length;n++){let o=~~((20-e[n].length)/2);y(e[n],o,t+n)}},M=e=>{for(let t=0;t<e[1].length;t++)y(e[1][t],0,t);y("<X>",17,0);let t=e[1].length%2?1:0;for(let n=0;n<e[2].length;n++)y(`${n+1} ${n===e[3]?"<":" "}${e[2][n][0]}${n===e[3]?">":" "}`,0,2*n+e[1].length+t)},F=e=>{let t=~~(e/500)%2?0:1,n=$[0]()[8],o=$[0]()[7],s=o[3],r=o[1],l=o[2],h=o[4],a=o[5],c=o[6],g=$[0]()[2],i=$[0]()[0],u=$[0]()[4]>=18||$[0]()[4]<6;for(let e=0;e<9;e++)for(let o=0;o<9;o++){let S=r-4+o,R=l-4+e;let E=16*t;if(d([S,R])){let e=s[R][S];e&&(E=16*e)}if(D.drawImage(v,E,0,16,16,16*(o+1),16*(e+1),16,16),0===h&&u)for(let s=0;s<n.length;s++){let r=n[s],l=r[0],h=r[1],a=r[2];l===S&&h===R&&r[3]>0&&(E=16*(7+t)+16*a*2,D.drawImage(B,E,0,16,16,16*(o+1),16*(e+1),16,16))}4===o&&4===e&&(E=g?16*t+16*i*2:64,D.drawImage(B,E,0,16,16,16*(o+1),16*(e+1),16,16)),0===h&&S===a-2&&R===c&&D.drawImage(B,80,0,16,16,16*(o+1),16*(e+1),16,16),0===h&&S===a-1&&R===c&&D.drawImage(B,96,0,16,16,16*(o+1),16*(e+1),16,16)}},Y=()=>{let e=$[0]()[1],t=$[0]()[2],n=$[0]()[9],o=$[0]()[10],s=$[0]()[11];y(`RANGER DOWN ${$[2]()}`,2.5,.5),D.drawImage(v,256,0,16,16,0,0,16,16),y(`${t}`,t<10?.5:0,2),D.drawImage(v,240,0,16,16,0,32,16,16),y(`${e}`,e<10?.5:0,6),D.drawImage(v,624,0,16,16,0,64,16,16),y(`${n}`,n<10?.5:0,10),D.drawImage(v,656,0,16,16,0,96,16,16),y(`${o}`,o<10?.5:0,14),D.drawImage(v,640,0,16,16,0,128,16,16),y(`${s}`,s<10?.5:0,18)},k=()=>{let e=$[0]()[7],t=e[1],n=e[1],o=e[3];for(let e=0;e<160;e++)for(let t=0;t<160;t++){0===o[e][t]?D.drawImage(v,432,0,1,1,t,e,1,1):D.drawImage(v,32,0,1,1,t,e,1,1)}for(let e=0;e<160;e++)for(let s=0;s<160;s++){let r=o[e][s];20===r&&D.drawImage(L,0,0,7,7,s-3,e-3,7,7),r>=28&&r<31&&D.drawImage(L,7,0,7,7,s-3,e-3,7,7),34===r&&D.drawImage(L,14,0,7,7,s-3,e-3,7,7),s===t&&e===n&&D.drawImage(L,21,0,7,7,s-3,e-3,7,7)}},D=c.getContext("2d");let U,v,B,G,L,$=(()=>{let e,t,o,s,l,h,a,c,u,S,R,f,I,T,C,y;let w=()=>{e=[],t=0,o=20,s=20,l=20,h=0,a=5,c=0,u=17,S=55,O[7]=m(e),f=[O[7],O[1],O[0]],R="",I=[],T=0,y=0,Y()},M=()=>{f.pop(),f.length||w()},F=([e,t])=>{let o=n(2),s=n(2)+1,r=O[7],l=r[3][t][e],h=r[1],a=r[2];A(l)||E(I,[e,t])||h===e&&a===t||I.push([e,t,o,s])},Y=()=>{for(;I.length<53;){let e=n(160),t=n(160);F([e,t])}},k=(e=0)=>{if(s<1)f=[O[13]];else{if(60==++S&&(S=0,u++,e?(s<l&&s++,6===u&&(R="")):(6===u&&(R="",f.push(O[2])),18===u&&(R="i",f.push(O[3])),o>0?(o--,s<l&&s++):(s--,f.push(O[12])))),24===u){y=0,u=0;let e=O[7];for(let t=0;t<160;t++)for(let n=0;n<160;n++)if(36===e[3][t][n]){let e=r([n,t]);for(let t=0;t<e.length;t++)F(e[t])}}(()=>{let e=([e,t])=>{for(let n=0;n<I.length;n++){let o=I[n],s=o[0],r=o[1];if(o[3]>0&&e===s&&t===r)return 1}};for(let t=0;t<I.length;t++){let o=I[t],r=o[0],l=o[1],h=f[f.length-1],a=O[7],c=a[1],g=a[2],S=[r,l];if((u>=18||u<6)&&Math.random()<.66){let e=i([r,l],[c,g]);S[0]=e[0],S[1]=e[1]}else n(2)?S[0]=r+(n(3)-1):S[1]=l+(n(3)-1);let R=a[3][S[1]][S[0]];A(R)||e([S[0],S[1]])||c===S[0]&&g===S[1]||(o[0]=S[0],o[1]=S[1],S[0]<r&&(o[2]=1),S[0]>r&&(o[2]=0)),3===h[0]&&0===h[4]&&(u>=18||u<6)&&c===S[0]&&g===S[1]&&n(2)&&s>0&&o[3]>0&&s--}})()}},D=[()=>{for(;6!==u;)k(1)},()=>{C[0]=1,h--},()=>{for(let e=0;e<60;e++)k();if(s>0){let e=n(16);if(e<2){let e=n(3)+1;f.push([1,[`Found ${e} food`]]),o+=e}else e<4?(f.push([1,["Found keycard"]]),h++):e<6?(f.push([1,["Found chip"]]),a++):e<8?(f.push([1,["Found backup"]]),c++):e<9?(f.push([1,["Rocks fell!","","Lost health"]]),s--):f.push([1,["Found nothing"]])}},()=>{C[1]?f.push(O[24]):f.push(O[4])},()=>{f.push([1,["Replaced 6 chips"]]),a-=6,C[1]=1},()=>{let e=n(3)+6;y=1,o+=e,f.push([1,[`Synthesized ${e} food`]])},()=>{y?f.push(O[25]):f.push(O[6])},()=>{},()=>{},()=>{},()=>{let e=O[7],t=e[1],n=e[2],o=[5,t,n,e[3]];console.log("showing map",{playerX:t,playerY:n}),f.push(o)}];return w(),[()=>[t,o,s,l,u,S,(()=>0===f[f.length-1][0]?"g":1===f[f.length-1][0]?"g":5===f[f.length-1][0]?"a":2===f[f.length-1][0]?f[f.length-1][4]:R)(),f[f.length-1],I,h,a,c],w,()=>`${u<10?"0":""}${u}:${S<10?"0":""}${S}`,k,(o,r)=>{let l=f[f.length-1];if(3!==l[0])return;let c;if(k(),-1===o&&(t=1),1===o&&(t=0),o=l[1]+o,r=l[2]+r,(u>=18||u<6)&&0===l[4])for(let e=0;e<I.length;e++)I[e][0]===o&&I[e][1]===r&&I[e][3]>0&&(c=I[e]);s>0&&d([o,r])&&!A(l[3][r][o])&&!c&&(l[1]=o,l[2]=r),0===l[4]&&(20===l[3][r][o]&&((C=e[160*r+o])[0]?f.push((()=>{let e=p(),t=g([0,0],([t,n])=>1===e[n][t]);return N(e,t,()=>27),e[19][18]=21,e[19][19]=22,e[19][20]=23,e[20][18]=2,e[20][19]=2,e[20][20]=2,e[21][18]=24,e[21][19]=25,e[21][20]=26,[3,20,20,e,1,20,20]})()):h?f.push(O[16]):f.push(O[15])),r===l[6]&&o===l[5]-1&&f.push(O[8]),c&&n(2)&&c[3]--,38!==l[3][r][o]||T||(T=1,f.push(O[14]),h++),l[3][r][o]>=28&&l[3][r][o]<31&&f.push(O[18])),1===l[4]&&(26===l[3][r][o]&&f.pop(),21===l[3][r][o]&&(!C[1]&&a>=6?f.push(O[22]):f.push(O[20])),23===l[3][r][o]&&(u>=18||u<6?f.push(O[9]):f.push(O[10])))},M,e=>{2===f[f.length-1][0]&&(f[f.length-1][3]=e)},()=>{if(2===f[f.length-1][0]){let e=f[f.length-1];if(!e[2].length)return void f.pop();let t=e[3],n=e[2][t][1];-1===n?M():4===O[n][0]?(f.pop(),D[O[n][1]]()):f.push(O[n])}}]})();document.onkeyup=(e=>{let t=$[0]()[7];if(3===t[0]&&(e=>{65!==e.keyCode&&37!==e.keyCode||$[4](-1,0),68!==e.keyCode&&39!==e.keyCode||$[4](1,0),87!==e.keyCode&&38!==e.keyCode||$[4](0,-1),83!==e.keyCode&&40!==e.keyCode||$[4](0,1)})(e),0!==t[0]&&1!==t[0]&&5!==t[0]||32!==e.keyCode&&27!==e.keyCode&&13!==e.keyCode||$[5](),2===t[0]){let n=t;27===e.keyCode&&$[5](),87!==e.keyCode&&38!==e.keyCode||n[3]>0&&$[6](n[3]-1),83!==e.keyCode&&40!==e.keyCode||n[3]<n[2].length-1&&$[6](n[3]+1),32!==e.keyCode&&13!==e.keyCode||$[7]()}});let P=([e,t])=>{let n=$[0]()[7],s=c.getBoundingClientRect().width/10,r=~~((e-c.getBoundingClientRect().left)/s)-1,l=~~((t-c.getBoundingClientRect().top)/s)-1;if(3===n[0]){if(4===r&&4===l)return;if(r<0||l<0)return;let e=o(r,4),t=o(l,4);let n=0,s=0;e>t?n=r>4?1:-1:e<t&&(s=l>4?1:-1),$[4](n,s)}if(0!==n[0]&&1!==n[0]&&5!==n[0]||$[5](),2===n[0]){l<0&&$[5]();let e=n,t=e[1].length%2?1:0,o=(e[1].length+t)/2,s=e[2].length,r=l-o+1;r>=0&&r<s&&(r===e[3]?$[7]():$[6](r))}};c.ontouchend=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)P([e.changedTouches[t].clientX,e.changedTouches[t].clientY])}),c.onclick=(e=>{e.preventDefault(),P([e.clientX,e.clientY])}),((...t)=>Promise.all(t.map(e)))("f.gif","t.gif","p.gif","s.png","c.gif").then(e=>{[U,v,B,G,L]=e,requestAnimationFrame(T)})};s();