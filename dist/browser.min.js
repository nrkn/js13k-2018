let s=()=>{let e=e=>new Promise(t=>{let n=new Image;n.onload=(()=>t(n)),n.src=e}),t=e=>e[n(e.length)],n=(e,t=0)=>~~(Math.random()*e)+t,o=(e,t)=>Math.max(e,t)-Math.min(e,t),s=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]],r=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1],[e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]],l=(e,t,n)=>s(t).filter(t=>e[t[1]][t[0]]===n),a=([e,t],[n,s])=>Math.hypot(o(e,n),o(t,s)),h=(e,t)=>{let n,o=25600;for(let s=0;s<t.length;s++){let r=a(e,t[s]);r<o&&(o=r,n=t[s])}return n},i=([e,t],n)=>{let o=[],r=[[e,t,0]],l=[],a=([e,t,a])=>{E([e,t])&&n([e,t])&&(l[160*t+e]||(o.push([e,t,a]),l[160*t+e]=1,r.push(...s([e,t]).map(([e,t])=>[e,t,a+1]))))};for(;r.length;)a(r.shift());return o},g=([e,t],[n,s])=>{let r=o(e,n),l=o(t,s),a=e,h=t;return r>l&&(n>e&&(a=e+1),e>n&&(a=e-1)),l>r&&(s>t&&(h=t+1),t>s&&(h=t-1)),[a,h]},u=([e,n],[o,r],l=E,a=.66)=>{let h=[],c=[],i=([e,n])=>{c[160*n+e]||(h.push([e,n]),c[160*n+e]=1),e===o&&n===r||i(Math.random()<a?t(s([e,n]).filter(l))||[e,n]:g([e,n],[o,r]))};return i([e,n]),h},S=e=>[3===e?20:1===e?140:n(120,20),0===e?20:2===e?140:n(120,20)],R=()=>[n(120,20),n(120,20)],d=(e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return!0;return!1},E=([e,t])=>e>=0&&e<=159&&t>=0&&t<=159,f=([e,t])=>e>=8&&e<=152&&t>=8&&t<=152,p=()=>{let e=[];for(let t=0;t<160;t++){let t=[];for(let e=0;e<160;e++)t.push(1);e.push(t)}return e},N=(e,t,n)=>{for(let o=0;o<t.length;o++){let[s,r]=t[o];e[r][s]=n([s,r])}},I=e=>{let t=0;let o=(e=>e.slice().sort(()=>n(3)-1))([0,3,6,9]);for(let s=0;s<160;s++)for(let r=0;r<160;r++)if(1===e[s][r]){let l=i([r,s],([t,n])=>1===e[n][t]);let a=0;l.length>5&&(a=t<4?o[t]:n(10),t++),N(e,l,a<3?()=>n(9)+2:a<6?()=>n(3)?n(4)+11:n(9)+2:a<9?()=>n(4)?n(3)+31:n(9)+2:()=>0)}},m=e=>{let o=p(),c=n(10,40),g=[S(0),S(1),S(2),S(3)];for(;g.length<c;){let e=R(),t=h(e,g);a(e,t)>10&&g.push(e)}let d=[],E=g.slice();let m=E.pop();let A=m;for(;E.length;){let e=h(m,E),t=u(m,e,f,.33);d.push(...t),m=E.pop()}let O=u(m,A,f,.33);d.push(...O);for(let e=0;e<10;e++){let e=u(t(g),t(g),f,.33);d.push(...e)}let T=[];for(let e=0;e<g.length;e++)T.push(...r(g[e]));let y=((e,n=8448)=>{let o=e.slice(),r=[];for(let e=0;e<o.length;e++){let[t,n]=o[e];r[160*n+t]=1}for(;o.length<n;){let[e,n]=t(o),l=s([e,n]);if(l.length){let[e,n]=t(l);r[160*n+e]||(o.push([e,n]),r[160*n+e]=1)}}return o})((e=>{let t=[],n=[];for(let o=0;o<e.length;o++){let[s,r]=e[o];n[160*r+s]||(t.push(e[o]),n[160*r+s]=1)}return console.log("unique",e.length,t.length),t})([...g,...T,...d])),[C,w]=(e=>{let t=160,n=[0,0];for(let o=0;o<e.length;o++){let[s,r]=e[o];s<t&&(t=s,n=[s,r])}return n})(y);N(o,y,()=>2);let M=i([0,0],([e,t])=>1===o[t][e]);N(o,M,()=>0);let k=((e,t)=>t.slice().sort((t,n)=>a(e,t)-a(e,n)))([C,w],g),F=u([C,w],k[0],f,.33);d.push(...F),I(o),(e=>{for(let t=0;t<160;t++)for(let o=0;o<160;o++)2===e[t][o]&&(l(e,[o,t],0).length?e[t][o]=n(3)+17:e[t][o]=n(13)+2)})(o),N(o,d,([e,t])=>o[t][e]>=17&&o[t][e]<20?o[t][e]:2),N(o,T,([e,t])=>o[t][e]>=17&&o[t][e]<20?o[t][e]:n(9)+2);for(let t=0;t<k.length;t++){let[s,r]=k[t],l=n(10);0===t?o[r][s]=38:1===t?(o[r][s]=20,e[160*r+s]=[0,0]):2===t?o[r][s]=n(3)+28:t===k.length-1?o[r][s]=34:l<6?o[r][s]=n(3)+28:l<9?(o[r][s]=20,e[160*r+s]=[0,0]):o[r][s]=36}return[3,C,w,o,0,C,w]},A=e=>e<2||e>=11&&e<15||20===e||27===e||24===e||25===e||26===e||21===e||22===e||23===e||e>=28&&e<31||e>=31&&e<34,O=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","--------------------","MAIN MENU","","ERROR:"," MAIN SYSTEM OFFLINE","","EMERGENCY OPS:",""],[["DIAGNOSTICS",5],["SYNTHESIZE",27]],0,"a"],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," OFFLINE","  6 BAD CHIPS","SYNTHESIZE:"," ONLINE","  DB ERRORS","COMMS:"," OFFLINE","  UNKNOWN ERROR","SECURITY:"," OFFLINE","  DB ERRORS","MAP:"," OFFLINE","  DB ERRORS"],[],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","  USE RESTORE DISK","POWER:"," FULL","","EMERGENCY OPS:",""],[["BASIC RATIONS",26]],0,"a"],[3,0,0,[[]],0,0,0],[1,["I should","investigate"]],[2,["Sleep?",""],[["Yes",11],["No",-1]],0,"g"],[1,["I'm not tired!"]],[4,0],[1,["I'm hungry!"]],[1,["You died"]],[1,["It's RANGER!","","RANGER is DEAD!","","Found keycard"]],[1,["It's locked!"]],[2,["It's locked!","","Use keycard?",""],[["Yes",17],["No",-1]],0,"g"],[4,1],[2,["Search ruins?","","1 hour",""],[["Yes",19],["No",-1]],0,"g"],[4,2],[2,["A computer",""],[["Use",21]],0,"g"],[4,3],[2,["A computer",""],[["Use",21],["Fix Chips",23],["Restore Backups",41]],0,"g"],[4,4],[2,["RSOS v3.27","--------------------","MAIN MENU","","OPS:",""],[["DIAGNOSTICS",32],["SYNTHESIZE",6],["DATABASE",28],["COMMS",29],["SECURITY",30],["MAP",31]],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","  USE RESTORE DISK","POWER:"," CHARGING",""],[],0,"a"],[4,5],[4,6],[4,7],[4,8],[4,9],[4,10],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," ONLINE","SYNTHESIZE:"," ONLINE","  DB ERRORS","COMMS:"," OFFLINE","  UNKNOWN ERROR","SECURITY:"," OFFLINE","  DB ERRORS","MAP:"," OFFLINE","  DB ERRORS"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 1","","USER: RANGER","","Sent to investigate","ruins. Found strange","technology"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 2","","USER: RANGER","","Was testing strange","technology. Portals","appeared!"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 3","","USER: RANGER","","Monsters coming out","of portals! Made it","back to hut. They","only come out at","night"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 4","","USER: RANGER","","Monsters affecting","computers. Have been","stashing items in","ruins for emergency.","Tried comms but the","satellite is offline"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 5","","USER: RANGER","","Found way to use","synth to alter chip","to shut down portal","but computer went","offline! There are","more of them every","night"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 6","","USER: RANGER","","Got computer online.","Still has errors.","Security system","should be able to","deal with monsters","if can get it online"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 7","","USER: RANGER","","Comms damaged beyond","repair but can send","a distress signal if","repair the satellite","transmitter with","some chips. Not sure","where the dish is","on island and maps","are offline"],[],0,"a"],[2,["RSOS v3.27","--------------------","DATABASE ENTRY 8","","USER: RANGER","","No way to warn","rescue team of","monsters with comms","offline. Can't send","distress signal","until deal with","monsters!"],[],0,"a"],[4,11]],T=e=>{let t=$[0]()[6],n=$[0]()[7];c.className=t,c.width=c.height=160,3===n[0]&&(k(e),F()),0===n[0]&&"s.png"===n[1]&&D.drawImage(G,0,0),1===n[0]&&w(n[1]),2===n[0]&&M(n),5===n[0]&&Y(),requestAnimationFrame(T)},y=(e="",t=0,n=0)=>D.drawImage(U,8*(e.charCodeAt(0)-32),0,8,8,8*t,8*n,8,8),C=(e="",t=0,n=0)=>{for(let o=0;o<e.length;o++)y(e[o],t+o,n)},w=e=>{let t=~~((20-e.length)/2);for(let n=0;n<e.length;n++){let o=~~((20-e[n].length)/2);C(e[n],o,t+n)}},M=e=>{for(let t=0;t<e[1].length;t++)C(e[1][t],0,t);C("<X>",17,0);let t=e[1].length%2?1:0;for(let n=0;n<e[2].length;n++)C(`${n+1} ${n===e[3]?"<":" "}${e[2][n][0]}${n===e[3]?">":" "}`,0,2*n+e[1].length+t)},k=e=>{let t=~~(e/500)%2?0:1,n=$[0]()[8],o=$[0]()[7],s=o[3],r=o[1],l=o[2],a=o[4],h=o[5],c=o[6],i=$[0]()[2],g=$[0]()[0],u=$[0]()[4]>=18||$[0]()[4]<6;for(let e=0;e<9;e++)for(let o=0;o<9;o++){let S=r-4+o,R=l-4+e;let d=16*t;if(E([S,R])){let e=s[R][S];e&&(d=16*e)}if(D.drawImage(v,d,0,16,16,16*(o+1),16*(e+1),16,16),0===a&&u)for(let s=0;s<n.length;s++){let r=n[s],l=r[0],a=r[1],h=r[2];l===S&&a===R&&r[3]>0&&(d=16*(7+t)+16*h*2,D.drawImage(B,d,0,16,16,16*(o+1),16*(e+1),16,16))}4===o&&4===e&&(d=i?16*t+16*g*2:64,D.drawImage(B,d,0,16,16,16*(o+1),16*(e+1),16,16)),0===a&&S===h-2&&R===c&&D.drawImage(B,80,0,16,16,16*(o+1),16*(e+1),16,16),0===a&&S===h-1&&R===c&&D.drawImage(B,96,0,16,16,16*(o+1),16*(e+1),16,16)}},F=()=>{let e=$[0]()[1],t=$[0]()[2],n=$[0]()[9],o=$[0]()[10],s=$[0]()[11];C(`RANGER DOWN ${$[2]()}`,2.5,.5),D.drawImage(v,256,0,16,16,0,0,16,16),C(`${t}`,t<10?.5:0,2),D.drawImage(v,240,0,16,16,0,32,16,16),C(`${e}`,e<10?.5:0,6),D.drawImage(v,624,0,16,16,0,64,16,16),C(`${n}`,n<10?.5:0,10),D.drawImage(v,656,0,16,16,0,96,16,16),C(`${o}`,o<10?.5:0,14),D.drawImage(v,640,0,16,16,0,128,16,16),C(`${s}`,s<10?.5:0,18)},Y=()=>{let e=$[0]()[7],t=e[1],n=e[1],o=e[3],s=e[4];for(let e=0;e<160;e++)for(let t=0;t<160;t++){let n=~~(t/32),r=~~(e/32),l=o[e][t];s[5*r+n]?0===l?D.drawImage(v,432,0,1,1,t,e,1,1):D.drawImage(v,32,0,1,1,t,e,1,1):t>8&&e>8&&(t%2&&!(e%2)||!(t%2)&&e%2)&&D.drawImage(v,32,0,1,1,t,e,1,1)}for(let e=0;e<160;e++)for(let r=0;r<160;r++){let l=~~(r/32),a=~~(e/32),h=o[e][r];s[5*a+l]&&(20===h&&D.drawImage(L,0,0,7,7,r-3,e-3,7,7),h>=28&&h<31&&D.drawImage(L,7,0,7,7,r-3,e-3,7,7),34===h&&D.drawImage(L,14,0,7,7,r-3,e-3,7,7),r===t&&e===n&&D.drawImage(L,21,0,7,7,r-3,e-3,7,7))}for(let e=0;e<32;e++)D.drawImage(U,8*(16+e),0,8,8,0,32*e+16,8,8);for(let e=0;e<32;e++)D.drawImage(U,8*(33+e),0,8,8,32*e+16,0,8,8)},D=c.getContext("2d");let U,v,B,G,L,$=(()=>{let e,t,o,s,l,a,h,c,u,S,R,f,I,T,y,C,w,M;let k=()=>{e=[],t=0,o=20,s=20,l=20,a=0,h=5,c=0,u=17,S=55,O[7]=m(e),f=[O[7],O[1],O[0]],R="",I=[],T=0,C=0,w=[33],M=[];let n=O[7],r=n[1],i=n[2];M[5*~~(i/32)+~~(r/32)]=1,D()},F=()=>{f.pop(),f.length||k()},Y=([e,t])=>{let o=n(2),s=n(2)+1,r=O[7],l=r[3][t][e],a=r[1],h=r[2];A(l)||d(I,[e,t])||a===e&&h===t||I.push([e,t,o,s])},D=()=>{for(;I.length<53;){let e=n(160),t=n(160);Y([e,t])}},U=(e=0)=>{if(s<1)f=[O[13]];else{if(60==++S&&(S=0,u++,e?(s<l&&s++,6===u&&(R="")):(6===u&&(R="",f.push(O[2])),18===u&&(R="i",f.push(O[3])),o>0?(o--,s<l&&s++):(s--,f.push(O[12])))),24===u){C=0,u=0;let e=O[7];for(let t=0;t<160;t++)for(let n=0;n<160;n++)if(36===e[3][t][n]){let e=r([n,t]);for(let t=0;t<e.length;t++)Y(e[t])}}(()=>{let e=([e,t])=>{for(let n=0;n<I.length;n++){let o=I[n],s=o[0],r=o[1];if(o[3]>0&&e===s&&t===r)return 1}};for(let t=0;t<I.length;t++){let o=I[t],r=o[0],l=o[1],a=f[f.length-1],h=O[7],c=h[1],i=h[2],S=[r,l];if((u>=18||u<6)&&Math.random()<.66){let e=g([r,l],[c,i]);S[0]=e[0],S[1]=e[1]}else n(2)?S[0]=r+(n(3)-1):S[1]=l+(n(3)-1);let R=h[3][S[1]][S[0]];A(R)||e([S[0],S[1]])||c===S[0]&&i===S[1]||(o[0]=S[0],o[1]=S[1],S[0]<r&&(o[2]=1),S[0]>r&&(o[2]=0)),3===a[0]&&0===a[4]&&(u>=18||u<6)&&c===S[0]&&i===S[1]&&n(2)&&s>0&&o[3]>0&&s--}})()}},v=[()=>{for(;6!==u;)U(1)},()=>{y[0]=1,a--},()=>{for(let e=0;e<60;e++)U();if(s>0){let e=n(16);if(e<2){let e=n(3)+1;f.push([1,[`Found ${e} food`]]),o+=e}else e<4?(f.push([1,["Found keycard"]]),a++):e<6?(f.push([1,["Found chip"]]),h++):e<8?(f.push([1,["Found backup"]]),c++):e<9?(f.push([1,["Rocks fell!","","Lost health"]]),s--):f.push([1,["Found nothing"]])}},()=>{y[1]?f.push(O[24]):f.push(O[4])},()=>{f.push([1,["Replaced 6 chips"]]),h-=6,y[1]=1},()=>{let e=n(3)+6;C=1,o+=e,f.push([1,[`Synthesized ${e} food`]])},()=>{C?f.push(O[25]):f.push(O[6])},()=>{let e=[2,["RSOS v3.27","--------------------","DATABASE MENU"],w.map(e=>[`ENTRY ${e}`,e]),0,"a"];f.push(e)},()=>{},()=>{},()=>{let e=O[7],t=e[1],n=e[2],o=[5,t,n,e[3],M];console.log("showing map",{playerX:t,playerY:n}),f.push(o)},()=>{if(c--,n(2)<1){let e=w.length+33;e<41?(w.push(e),f.push([1,["Recovered 1 note","database entry"]])):(f.push([1,["Could not read disk,","try again"]]),c++)}else{let e=n(5),t=n(5);M[5*t+e]?(f.push([1,["Could not read disk,","try again"]]),c++):(M[5*t+e]=1,f.push([1,["Recovered 1 map","database entry"]]))}}];return k(),[()=>[t,o,s,l,u,S,(()=>0===f[f.length-1][0]?"g":1===f[f.length-1][0]?"g":5===f[f.length-1][0]?"a":2===f[f.length-1][0]?f[f.length-1][4]:R)(),f[f.length-1],I,a,h,c],k,()=>`${u<10?"0":""}${u}:${S<10?"0":""}${S}`,U,(o,r)=>{let l=f[f.length-1];if(3!==l[0])return;let g;if(U(),-1===o&&(t=1),1===o&&(t=0),o=l[1]+o,r=l[2]+r,(u>=18||u<6)&&0===l[4])for(let e=0;e<I.length;e++)I[e][0]===o&&I[e][1]===r&&I[e][3]>0&&(g=I[e]);if(s>0&&E([o,r])&&!A(l[3][r][o])&&!g&&(l[1]=o,l[2]=r),0===l[4]&&(20===l[3][r][o]&&((y=e[160*r+o])[0]?f.push((()=>{let e=p(),t=i([0,0],([t,n])=>1===e[n][t]);return N(e,t,()=>27),e[19][18]=21,e[19][19]=22,e[19][20]=23,e[20][18]=2,e[20][19]=2,e[20][20]=2,e[21][18]=24,e[21][19]=25,e[21][20]=26,[3,20,20,e,1,20,20]})()):a?f.push(O[16]):f.push(O[15])),r===l[6]&&o===l[5]-1&&f.push(O[8]),g&&n(2)&&g[3]--,38!==l[3][r][o]||T||(T=1,f.push(O[14]),a++),l[3][r][o]>=28&&l[3][r][o]<31&&f.push(O[18])),1===l[4]){if(26===l[3][r][o]&&f.pop(),21===l[3][r][o]){let e=O[22].slice();e[2]=e[2].filter((e,t)=>1===t&&y[1]?0:1===t&&h<6?0:2!==t||y[1]?2===t&&c<1?0:1:0),f.push(e)}23===l[3][r][o]&&(u>=18||u<6?f.push(O[9]):f.push(O[10]))}},F,e=>{2===f[f.length-1][0]&&(f[f.length-1][3]=e)},()=>{if(2===f[f.length-1][0]){let e=f[f.length-1];if(!e[2].length)return void f.pop();let t=e[3],n=e[2][t][1];-1===n?F():4===O[n][0]?(f.pop(),v[O[n][1]]()):f.push(O[n])}}]})();document.onkeyup=(e=>{let t=$[0]()[7];if(3===t[0]&&(e=>{65!==e.keyCode&&37!==e.keyCode||$[4](-1,0),68!==e.keyCode&&39!==e.keyCode||$[4](1,0),87!==e.keyCode&&38!==e.keyCode||$[4](0,-1),83!==e.keyCode&&40!==e.keyCode||$[4](0,1)})(e),0!==t[0]&&1!==t[0]&&5!==t[0]||32!==e.keyCode&&27!==e.keyCode&&13!==e.keyCode||$[5](),2===t[0]){let n=t;27===e.keyCode&&$[5](),87!==e.keyCode&&38!==e.keyCode||n[3]>0&&$[6](n[3]-1),83!==e.keyCode&&40!==e.keyCode||n[3]<n[2].length-1&&$[6](n[3]+1),32!==e.keyCode&&13!==e.keyCode||$[7]()}});let b=([e,t])=>{let n=$[0]()[7],s=c.getBoundingClientRect().width/10,r=~~((e-c.getBoundingClientRect().left)/s)-1,l=~~((t-c.getBoundingClientRect().top)/s)-1;if(3===n[0]){if(4===r&&4===l)return;if(r<0||l<0)return;let e=o(r,4),t=o(l,4);let n=0,s=0;e>t?n=r>4?1:-1:e<t&&(s=l>4?1:-1),$[4](n,s)}if(0!==n[0]&&1!==n[0]&&5!==n[0]||$[5](),2===n[0]){l<0&&$[5]();let e=n,t=e[1].length%2?1:0,o=(e[1].length+t)/2,s=e[2].length,r=l-o+1;r>=0&&r<s&&(r===e[3]?$[7]():$[6](r))}};c.ontouchend=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)b([e.changedTouches[t].clientX,e.changedTouches[t].clientY])}),c.onclick=(e=>{e.preventDefault(),b([e.clientX,e.clientY])}),((...t)=>Promise.all(t.map(e)))("f.gif","t.gif","p.gif","s.png","c.gif").then(e=>{[U,v,B,G,L]=e,requestAnimationFrame(T)})};s();