let s=()=>{let e=e=>new Promise(t=>{let n=new Image;n.onload=(()=>t(n)),n.src=e}),t=e=>e[n(e.length)],n=(e,t=0)=>~~(Math.random()*e)+t,o=(e,t)=>Math.max(e,t)-Math.min(e,t),r=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]],s=(e,t,n)=>r(t).filter(t=>e[t[1]][t[0]]===n),l=(e,[n,r],s,l)=>{let h=e.filter(([e,t])=>o(e,n)>=s&&o(t,r)>=s&&o(e,n)<=l&&o(t,r)<=l);return t(h)},h=([e,t],n)=>{let o=[],s=[[e,t,0]],l=[],h=([e,t,h])=>{p([e,t])&&n([e,t])&&(l[128*t+e]||(o.push([e,t,h]),l[128*t+e]=!0,s.push(...r([e,t]).map(([e,t])=>[e,t,h+1]))))};for(;s.length;)h(s.shift());return o},g=(e,[t,n])=>{let o=[],[s,l]=e[0],h=((e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return e[o]})(e,[t,n]);if(!h)return o;let c=[h],g=([t,n,h])=>{if(o.unshift([t,n]),t===s&&n===l)return;let g;r([t,n]).forEach(([t,n])=>{let o=e.find(([e,o])=>e===t&&o===n);if(o){let[,,e]=o;e<h&&(h=e,g=o)}}),g&&c.push(g)};for(;c.length;)g(c.shift());return o},f=([e,t],[n,r])=>{let s=o(e,n),l=o(t,r),h=e,c=t;return s>l&&(n>e&&(h=e+1),e>n&&(h=e-1)),l>s&&(r>t&&(c=t+1),t>r&&(c=t-1)),[h,c]},i=([e,n],[o,s],l=p,h=.66)=>{let c=[],g=([e,n])=>{d(c,[e,n])||c.push([e,n]),e===o&&n===s||g(Math.random()<h?t(r([e,n]).filter(l))||[e,n]:f([e,n],[o,s]))};return g([e,n]),c},u=e=>[3===e?21:1===e?107:n(86,21),0===e?21:2===e?107:n(86,21)],a=()=>[n(86,21),n(86,21)],d=(e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return!0;return!1},p=([e,t])=>e>=0&&e<=127&&t>=0&&t<=127,C=([e,t])=>e>=8&&e<=120&&t>=8&&t<=120,S=()=>{let e=[];for(let t=0;t<128;t++){let t=[];for(let e=0;e<128;e++)t.push(1);e.push(t)}return e},I=(e,t,n)=>{for(let o=0;o<t.length;o++){let[r,s]=t[o];e[s][r]=n([r,s])}},m=()=>{let e=S(),o=n(15,10),r=[u(0),u(1),u(2),u(3)];for(let e=4;e<o;e++)r.push(a());for(let t=1;t<o;t++){let n=i(r[t-1],r[t],C);I(e,n,()=>2)}let c=((e,t)=>{let n=[];for(let o=0;o<128;o++)for(let r=0;r<128;r++)e[o][r]===t&&n.push([r,o]);return n})(e,2),f=c.slice();((e,n,o=4096)=>{for(;n.length<o;){let[o,r]=t(n),l=s(e,[o,r],1).filter(C);if(l.length){let[o,r]=t(l);d(n,[o,r])||(n.push([o,r]),e[r][o]=2)}}})(e,c);let p=h([0,0],([t,n])=>1===e[n][t]);I(e,p,()=>0),((e,t)=>{for(let o=0;o<128;o++)for(let r=0;r<128;r++)if(2===e[o][r]&&(s(e,[r,o],0).length?e[o][r]=n(3)+17:d(t,[r,o])?e[o][r]=n(9)+2:e[o][r]=n(13)+2),1===e[o][r]){let t=h([r,o],([t,n])=>1===e[n][t]);n(3)?I(e,t,()=>n(4)+11):n(3)?I(e,t,()=>n(3)+31):n(3)?I(e,t,()=>n(9)+2):I(e,t,()=>0)}})(e,f);let[m,E]=(e=>{let t=128,n=[0,0];for(let o=0;o<e.length;o++){let[r,s]=e[o];r<t&&(t=r,n=[r,s])}return n})(c);let N;for(;!N;)N=l(f,[m,E],n(5)+10,n(5)+20);let[k,y]=N;let R;for(;!R;)R=l(f,[k,y],n(5)+10,n(5)+20);let[O,M]=R,w=[[m,E],[k,y],[O,M]];for(;w.length<15;){let[o,r]=t(w),s=12*n(10),c=12*n(10),i=l(f,[s,c],1,12),u=h([o,r],([t,n])=>0!==e[n][t]);if(i&&u.length){let t=g(u,i);w.push(i),I(e,t,([t,n])=>e[n][t]>=17&&e[n][t]<20?e[n][t]:2)}}for(let t=2;t<15;t++){let[o,r]=w[t];n(3)?e[r][o]=n(3)+28:e[r][o]=20}return[3,m,E,e,0,m,E]},E=e=>e<2||e>=11&&e<15||20===e||27===e||24===e||25===e||26===e||21===e||22===e||23===e||e>=28&&e<31||e>=31&&e<34,N=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","--------------------","MAIN MENU","","ERROR:"," SYSTEM OFFLINE","","EMERGENCY OPS:",""],[["DIAGNOSTICS",5],["SYNTHESIZE",6]],0,"a"],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," OFFLINE",""," PROBLEM:","  6 CAPS BLOWN","","SYNTHESIZE:"," ONLINE"],[],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","","EMERGENCY OPS:",""],[["BASIC RATIONS",-1]],0,"a"],m(),[1,["I should","investigate"]],[2,["Sleep?"],[["Yes",11],["No",-1]],0,"g"],[1,["I'm not tired!"]],[4,0],[1,["I'm hungry!"]],[1,["You died"]]],k=e=>{let t=B[0]()[6],n=B[0]()[7];c.className=t,c.width=c.height=160,3===n[0]&&(w(e),T()),0===n[0]&&"s.png"===n[1]&&A.drawImage(F,0,0),1===n[0]&&O(n[1]),2===n[0]&&M(n),requestAnimationFrame(k)},y=(e="",t=0,n=0)=>A.drawImage(Y,8*(e.charCodeAt(0)-32),0,8,8,8*t,8*n,8,8),R=(e="",t=0,n=0)=>{for(let o=0;o<e.length;o++)y(e[o],t+o,n)},O=e=>{let t=~~((20-e.length)/2);for(let n=0;n<e.length;n++){let o=~~((20-e[n].length)/2);R(e[n],o,t+n)}},M=e=>{for(let t=0;t<e[1].length;t++)R(e[1][t],0,t);R("<X>",17,0);let t=e[1].length%2?1:0;for(let n=0;n<e[2].length;n++)R(`${n+1} ${n===e[3]?"<":" "}${e[2][n][0]}${n===e[3]?">":" "}`,0,2*n+e[1].length+t)},w=e=>{let t=~~(e/500)%2?0:1,n=B[0]()[8],o=B[0]()[7],r=o[3],s=o[1],l=o[2],h=o[4],c=o[5],g=o[6],f=B[0]()[2],i=B[0]()[0],u=B[0]()[4]>=18||B[0]()[4]<6;for(let e=0;e<9;e++)for(let o=0;o<9;o++){let a=s-4+o,d=l-4+e;let C=16*t;if(p([a,d])){let e=r[d][a];e&&(C=16*e)}if(A.drawImage($,C,0,16,16,16*(o+1),16*(e+1),16,16),0===h&&u)for(let r=0;r<n.length;r++){let s=n[r],l=s[0],h=s[1],c=s[2];l===a&&h===d&&s[3]>0&&(C=16*(7+t)+16*c*2,A.drawImage(v,C,0,16,16,16*(o+1),16*(e+1),16,16))}4===o&&4===e&&(C=f?16*t+16*i*2:64,A.drawImage(v,C,0,16,16,16*(o+1),16*(e+1),16,16)),0===h&&a===c-2&&d===g&&A.drawImage(v,80,0,16,16,16*(o+1),16*(e+1),16,16),0===h&&a===c-1&&d===g&&A.drawImage(v,96,0,16,16,16*(o+1),16*(e+1),16,16)}},T=()=>{let e=B[0]()[1],t=B[0]()[2];R(`RANGER DOWN   ${B[2]()}`,.5,.5),A.drawImage($,256,0,16,16,0,16,16,16),R(`${t}`,t<10?.5:0,4),A.drawImage($,240,0,16,16,0,48,16,16),R(`${e}`,e<10?.5:0,8)},A=c.getContext("2d");let Y,$,v,F,B=(()=>{let e,t,o,r,s,l,c,g,i;let u=()=>{e=0,t=5,o=2,r=10,s=17,l=55,N[7]=m(),g=[N[7],N[1],N[0]],c="",i=[],C()},a=()=>{g.pop(),g.length||u()},C=()=>{for(;i.length<42;){let e=n(128),t=n(128),o=n(2),r=n(2)+1,s=N[7],l=s[3][t][e],h=s[1],c=s[2];E(l)||d(i,[e,t])||h===e&&c===t||i.push([e,t,o,r])}},k=()=>{for(let e=0;e<i.length;e++){let t=i[e],r=t[0],l=t[1],h=g[g.length-1],c=N[7],u=c[1],a=c[2],p=[r,l];if(Math.random()<.66){let e=f([r,l],[u,a]);p[0]=e[0],p[1]=e[1]}else n(2)?p[0]=r+(n(3)-1):p[1]=l+(n(3)-1);let C=c[3][p[1]][p[0]];E(C)||d(i,[p[0],p[1]])||u===p[0]&&a===p[1]||(t[0]=p[0],t[1]=p[1],p[0]<r&&(t[2]=1),p[0]>r&&(t[2]=0)),3===h[0]&&0===h[4]&&(s>=18||s<6)&&u===p[0]&&a===p[1]&&n(2)&&o>0&&t[3]>0&&o--}},y=()=>{o<1?g=[N[13]]:(60==++l&&(l=0,6==++s&&(c="",g.push(N[2])),18===s&&(c="i",g.push(N[3])),t>0?(t--,o<r&&o++):(o--,g.push(N[12]))),24===s&&(s=0),k())},R=[()=>{for(;5!==s||59!==l;)60==++l&&(l=0,s++,o<r&&o++),24===s&&(s=0),k()}];return u(),[()=>[e,t,o,r,s,l,(()=>0===g[g.length-1][0]?"g":1===g[g.length-1][0]?"g":2===g[g.length-1][0]?g[g.length-1][4]:c)(),g[g.length-1],i],u,()=>`${s<10?"0":""}${s}:${l<10?"0":""}${l}`,y,(t,r)=>{let l=g[g.length-1];if(3!==l[0])return;let c;if(y(),-1===t&&(e=1),1===t&&(e=0),t=l[1]+t,r=l[2]+r,(s>=18||s<6)&&0===l[4])for(let e=0;e<i.length;e++)i[e][0]===t&&i[e][1]===r&&i[e][3]>0&&(c=i[e]);o>0&&p([t,r])&&!E(l[3][r][t])&&!c&&(l[1]=t,l[2]=r),0===l[4]&&(20===l[3][r][t]&&g.push((()=>{let e=S(),t=h([0,0],([t,n])=>1===e[n][t]);return I(e,t,()=>27),e[20][19]=21,e[20][20]=22,e[20][21]=23,e[21][19]=2,e[21][20]=2,e[21][21]=2,e[22][19]=24,e[22][20]=25,e[22][21]=26,[3,21,21,e,1,21,21]})()),r===l[6]&&t===l[5]-1&&g.push(N[8]),c&&n(2)&&c[3]--),1===l[4]&&(26===l[3][r][t]&&g.pop(),21===l[3][r][t]&&g.push(N[4]),23===l[3][r][t]&&(s>=18||s<6?g.push(N[9]):g.push(N[10])))},a,e=>{2===g[g.length-1][0]&&(g[g.length-1][3]=e)},()=>{if(2===g[g.length-1][0]){let e=g[g.length-1];if(!e[2].length)return void g.pop();let t=e[3],n=e[2][t][1];-1===n?a():4===N[n][0]?(R[N[n][1]](),g.pop()):g.push(N[n])}}]})();document.onkeyup=(e=>{let t=B[0]()[7];if(3===t[0]&&(e=>{65!==e.keyCode&&37!==e.keyCode||B[4](-1,0),68!==e.keyCode&&39!==e.keyCode||B[4](1,0),87!==e.keyCode&&38!==e.keyCode||B[4](0,-1),83!==e.keyCode&&40!==e.keyCode||B[4](0,1)})(e),0!==t[0]&&1!==t[0]||32!==e.keyCode&&27!==e.keyCode&&13!==e.keyCode||B[5](),2===t[0]){let n=t;27===e.keyCode&&B[5](),87!==e.keyCode&&38!==e.keyCode||n[3]>0&&B[6](n[3]-1),83!==e.keyCode&&40!==e.keyCode||n[3]<n[2].length-1&&B[6](n[3]+1),32!==e.keyCode&&13!==e.keyCode||B[7]()}});let L=([e,t])=>{let n=B[0]()[7],r=c.getBoundingClientRect().width/10,s=~~((e-c.getBoundingClientRect().left)/r)-1,l=~~((t-c.getBoundingClientRect().top)/r)-1;if(3===n[0]){if(4===s&&4===l)return;if(s<0||l<0)return;let e=o(s,4),t=o(l,4);let n=0,r=0;e>t?n=s>4?1:-1:e<t&&(r=l>4?1:-1),B[4](n,r)}if(0!==n[0]&&1!==n[0]||B[5](),2===n[0]){l<0&&B[5]();let e=n,t=e[1].length%2?1:0,o=(e[1].length+t)/2,r=e[2].length,s=l-o+1;s>=0&&s<r&&(s===e[3]?B[7]():B[6](s))}};c.ontouchend=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)L([e.changedTouches[t].clientX,e.changedTouches[t].clientY])}),c.onclick=(e=>{e.preventDefault(),L([e.clientX,e.clientY])}),((...t)=>Promise.all(t.map(e)))("f.gif","t.gif","p.gif","s.png").then(e=>{[Y,$,v,F]=e,requestAnimationFrame(k)})};s();