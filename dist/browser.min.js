let s=()=>{let e=e=>new Promise(t=>{let n=new Image;n.onload=(()=>t(n)),n.src=e}),t=e=>e[n(e.length)],n=(e,t=0)=>~~(Math.random()*e)+t,o=(e,t)=>Math.max(e,t)-Math.min(e,t),r=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]],l=(e,t,n)=>r(t).filter(t=>e[t[1]][t[0]]===n),s=(e,[n,r],l,s)=>{let h=e.filter(([e,t])=>o(e,n)>=l&&o(t,r)>=l&&o(e,n)<=s&&o(t,r)<=s);return t(h)},h=([e,t],n)=>{let o=[],l=[[e,t,0]],s=[],h=([e,t,h])=>{p([e,t])&&n([e,t])&&(s[128*t+e]||(o.push([e,t,h]),s[128*t+e]=!0,l.push(...r([e,t]).map(([e,t])=>[e,t,h+1]))))};for(;l.length;)h(l.shift());return o},g=(e,[t,n])=>{let o=[],[l,s]=e[0],h=((e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return e[o]})(e,[t,n]);if(!h)return o;let c=[h],g=([t,n,h])=>{if(o.unshift([t,n]),t===l&&n===s)return;let g;r([t,n]).forEach(([t,n])=>{let o=e.find(([e,o])=>e===t&&o===n);if(o){let[,,e]=o;e<h&&(h=e,g=o)}}),g&&c.push(g)};for(;c.length;)g(c.shift());return o},f=([e,t],[n,r])=>{let l=o(e,n),s=o(t,r),h=e,c=t;return l>s&&(n>e&&(h=e+1),e>n&&(h=e-1)),s>l&&(r>t&&(c=t+1),t>r&&(c=t-1)),[h,c]},i=([e,n],[o,l],s=p,h=.66)=>{let c=[],g=([e,n])=>{d(c,[e,n])||c.push([e,n]),e===o&&n===l||g(Math.random()<h?t(r([e,n]).filter(s))||[e,n]:f([e,n],[o,l]))};return g([e,n]),c},u=e=>[3===e?21:1===e?107:n(86,21),0===e?21:2===e?107:n(86,21)],a=()=>[n(86,21),n(86,21)],d=(e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return!0;return!1},p=([e,t])=>e>=0&&e<=127&&t>=0&&t<=127,C=([e,t])=>e>=8&&e<=120&&t>=8&&t<=120,S=()=>{let e=[];for(let t=0;t<128;t++){let t=[];for(let e=0;e<128;e++)t.push(1);e.push(t)}return e},I=(e,t,n)=>{for(let o=0;o<t.length;o++){let[r,l]=t[o];e[l][r]=n([r,l])}},m=()=>{let e=S(),o=n(15,10),r=[u(0),u(1),u(2),u(3)];for(let e=4;e<o;e++)r.push(a());for(let t=1;t<o;t++){let n=i(r[t-1],r[t],C);I(e,n,()=>2)}let c=((e,t)=>{let n=[];for(let o=0;o<128;o++)for(let r=0;r<128;r++)e[o][r]===t&&n.push([r,o]);return n})(e,2),f=c.slice();((e,n,o=4096)=>{for(;n.length<o;){let[o,r]=t(n),s=l(e,[o,r],1).filter(C);if(s.length){let[o,r]=t(s);d(n,[o,r])||(n.push([o,r]),e[r][o]=2)}}})(e,c);let p=h([0,0],([t,n])=>1===e[n][t]);I(e,p,()=>0),((e,t)=>{for(let o=0;o<128;o++)for(let r=0;r<128;r++)2===e[o][r]&&(l(e,[r,o],0).length?e[o][r]=n(3)+14:d(t,[r,o])?e[o][r]=n(6)+2:e[o][r]=n(7)+2),1===e[o][r]&&(e[o][r]=n(2)+7)})(e,f);let[m,E]=(e=>{let t=128,n=[0,0];for(let o=0;o<e.length;o++){let[r,l]=e[o];r<t&&(t=r,n=[r,l])}return n})(c);let N;for(;!N;)N=s(f,[m,E],n(5)+10,n(5)+20);let[k,y]=N,[R,O]=s(f,[k,y],n(5)+10,n(5)+20),M=[[m,E],[k,y],[R,O]];for(;M.length<15;){let[o,r]=t(M),l=12*n(10),c=12*n(10),i=s(f,[l,c],1,12),u=h([o,r],([t,n])=>0!==e[n][t]);if(i&&u.length){let t=g(u,i);M.push(i),I(e,t,([t,n])=>e[n][t]>=14&&e[n][t]<17?e[n][t]:2)}}for(let t=2;t<15;t++){let[n,o]=M[t];e[o][n]=17}return[3,m,E,e,0,m,E]},E=e=>e<2||8===e||17===e||24===e||21===e||22===e||23===e||18===e||19===e||20===e,N=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","--------------------","MAIN MENU","","ERROR:"," SYSTEM OFFLINE","","EMERGENCY OPS:",""],[["DIAGNOSTICS",5],["SYNTHESIZE",6]],0,"a"],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," OFFLINE",""," PROBLEM:","  6 CAPS BLOWN","","SYNTHESIZE:"," ONLINE"],[],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","","EMERGENCY OPS:",""],[["BASIC RATIONS",-1]],0,"a"],m(),[1,["I should","investigate"]],[2,["Sleep?"],[["Yes",11],["No",-1]],0,"g"],[1,["I'm not tired!"]],[4,0],[1,["I'm hungry!"]]],k=e=>{let t=B[0]()[6],n=B[0]()[7];c.className=t,c.width=c.height=160,3===n[0]&&(w(e),T()),0===n[0]&&"s.png"===n[1]&&A.drawImage(v,0,0),1===n[0]&&O(n[1]),2===n[0]&&M(n),requestAnimationFrame(k)},y=(e="",t=0,n=0)=>A.drawImage(Y,8*(e.charCodeAt(0)-32),0,8,8,8*t,8*n,8,8),R=(e="",t=0,n=0)=>{for(let o=0;o<e.length;o++)y(e[o],t+o,n)},O=e=>{let t=~~((20-e.length)/2);for(let n=0;n<e.length;n++){let o=~~((20-e[n].length)/2);R(e[n],o,t+n)}},M=e=>{for(let t=0;t<e[1].length;t++)R(e[1][t],0,t);R("<X>",17,0);let t=e[1].length%2?1:0;for(let n=0;n<e[2].length;n++)R(`${n+1} ${n===e[3]?"<":" "}${e[2][n][0]}${n===e[3]?">":" "}`,0,2*n+e[1].length+t)},w=e=>{let t=~~(e/500)%2?0:1,n=B[0]()[8],o=B[0]()[7],r=o[3],l=o[1],s=o[2],h=o[4],c=o[5],g=o[6],f=B[0]()[2],i=B[0]()[0],u=B[0]()[4]>=18||B[0]()[4]<6;for(let e=0;e<9;e++)for(let o=0;o<9;o++){let a=l-4+o,d=s-4+e;let C=16*t;if(p([a,d])){let e=r[d][a];e&&(C=16*e)}if(A.drawImage($,C,0,16,16,16*(o+1),16*(e+1),16,16),0===h&&u)for(let r=0;r<n.length;r++){let l=n[r],s=l[0],h=l[1],c=l[2];s===a&&h===d&&l[3]>0&&(C=16*(7+t)+16*c*2,A.drawImage(F,C,0,16,16,16*(o+1),16*(e+1),16,16))}4===o&&4===e&&(C=f?16*t+16*i*2:64,A.drawImage(F,C,0,16,16,16*(o+1),16*(e+1),16,16)),0===h&&a===c-2&&d===g&&A.drawImage(F,80,0,16,16,16*(o+1),16*(e+1),16,16),0===h&&a===c-1&&d===g&&A.drawImage(F,96,0,16,16,16*(o+1),16*(e+1),16,16)}},T=()=>{let e=B[0]()[1],t=B[0]()[2];R(`RANGER DOWN   ${B[2]()}`,.5,.5),A.drawImage($,160,0,16,16,0,16,16,16),R(`${t}`,t<10?.5:0,4),A.drawImage($,144,0,16,16,0,48,16,16),R(`${e}`,e<10?.5:0,8)},A=c.getContext("2d");let Y,$,F,v,B=(()=>{let e,t,o,r,l,s,c,g,i;let u=()=>{e=0,t=5,o=2,r=10,l=17,s=55,N[7]=m(),g=[N[7],N[1],N[0]],c="",i=[],C()},a=()=>{g.pop(),g.length||(g=[N[7]])},C=()=>{for(;i.length<42;){let e=n(128),t=n(128),o=n(2),r=n(2)+1,l=N[7],s=l[3][t][e],h=l[1],c=l[2];E(s)||d(i,[e,t])||h===e&&c===t||i.push([e,t,o,r])}},k=()=>{for(let e=0;e<i.length;e++){let t=i[e],r=t[0],s=t[1],h=g[g.length-1],c=N[7],u=c[1],a=c[2],p=[r,s];if(Math.random()<.66){let e=f([r,s],[u,a]);p[0]=e[0],p[1]=e[1]}else n(2)?p[0]=r+(n(3)-1):p[1]=s+(n(3)-1);let C=c[3][p[1]][p[0]];E(C)||d(i,[p[0],p[1]])||u===p[0]&&a===p[1]||(t[0]=p[0],t[1]=p[1],p[0]<r&&(t[2]=1),p[0]>r&&(t[2]=0)),3===h[0]&&0===h[4]&&(l>=18||l<6)&&u===p[0]&&a===p[1]&&n(2)&&o>0&&t[3]>0&&o--}},y=()=>{o<1||(60==++s&&(s=0,6==++l&&(c="",g.push(N[2])),18===l&&(c="i",g.push(N[3])),t>0?(t--,o<r&&o++):(o--,g.push(N[12]))),24===l&&(l=0),k())},R=[()=>{for(;5!==l||59!==s;)60==++s&&(s=0,l++,o<r&&o++),24===l&&(l=0),k()}];return u(),[()=>[e,t,o,r,l,s,(()=>0===g[g.length-1][0]?"g":1===g[g.length-1][0]?"g":2===g[g.length-1][0]?g[g.length-1][4]:c)(),g[g.length-1],i],u,()=>`${l<10?"0":""}${l}:${s<10?"0":""}${s}`,y,(t,r)=>{let s=g[g.length-1];if(3!==s[0])return;let c;if(y(),-1===t&&(e=1),1===t&&(e=0),t=s[1]+t,r=s[2]+r,(l>=18||l<6)&&0===s[4])for(let e=0;e<i.length;e++)i[e][0]===t&&i[e][1]===r&&i[e][3]>0&&(c=i[e]);o>0&&p([t,r])&&!E(s[3][r][t])&&!c&&(s[1]=t,s[2]=r),0===s[4]&&(17===s[3][r][t]&&g.push((()=>{let e=S(),t=h([0,0],([t,n])=>1===e[n][t]);return I(e,t,()=>24),e[20][19]=18,e[20][20]=19,e[20][21]=20,e[21][19]=2,e[21][20]=2,e[21][21]=2,e[22][19]=21,e[22][20]=22,e[22][21]=23,[3,21,21,e,1,21,21]})()),r===s[6]&&t===s[5]-1&&g.push(N[8]),c&&n(2)&&c[3]--),1===s[4]&&(23===s[3][r][t]&&g.pop(),18===s[3][r][t]&&g.push(N[4]),20===s[3][r][t]&&(l>=18||l<6?g.push(N[9]):g.push(N[10])))},a,e=>{2===g[g.length-1][0]&&(g[g.length-1][3]=e)},()=>{if(2===g[g.length-1][0]){let e=g[g.length-1],t=e[3],n=e[2][t][1];-1===n?a():4===N[n][0]?(R[N[n][1]](),g.pop()):g.push(N[n])}}]})();document.onkeyup=(e=>{let t=B[0]()[7];if(3===t[0]&&(e=>{65!==e.keyCode&&37!==e.keyCode||B[4](-1,0),68!==e.keyCode&&39!==e.keyCode||B[4](1,0),87!==e.keyCode&&38!==e.keyCode||B[4](0,-1),83!==e.keyCode&&40!==e.keyCode||B[4](0,1)})(e),0!==t[0]&&1!==t[0]||32!==e.keyCode&&27!==e.keyCode&&13!==e.keyCode||B[5](),2===t[0]){let n=t;27===e.keyCode&&B[5](),87!==e.keyCode&&38!==e.keyCode||n[3]>0&&B[6](n[3]-1),83!==e.keyCode&&40!==e.keyCode||n[3]<n[2].length-1&&B[6](n[3]+1),32!==e.keyCode&&13!==e.keyCode||B[7]()}});let L=([e,t])=>{let n=B[0]()[7],r=c.getBoundingClientRect().width/10,l=~~((e-c.getBoundingClientRect().left)/r)-1,s=~~((t-c.getBoundingClientRect().top)/r)-1;if(3===n[0]){if(4===l&&4===s)return;if(l<0||s<0)return;let e=o(l,4),t=o(s,4);let n=0,r=0;e>t?n=l>4?1:-1:e<t&&(r=s>4?1:-1),B[4](n,r)}if(0!==n[0]&&1!==n[0]||B[5](),2===n[0]){s<0&&B[5]();let e=n,t=e[1].length%2?1:0,o=(e[1].length+t)/2,r=e[2].length,l=s-o+1;l>=0&&l<r&&(l===e[3]?B[7]():B[6](l))}};c.ontouchend=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)L([e.changedTouches[t].clientX,e.changedTouches[t].clientY])}),c.onclick=(e=>{e.preventDefault(),L([e.clientX,e.clientY])}),((...t)=>Promise.all(t.map(e)))("f.gif","t.gif","p.gif","s.png").then(e=>{[Y,$,F,v]=e,requestAnimationFrame(k)})};s();