let s=()=>{let e=e=>new Promise(t=>{let n=new Image;n.onload=(()=>t(n)),n.src=e}),t=e=>e[n(e.length)],n=(e,t=0)=>~~(Math.random()*e)+t,o=(e,t)=>Math.max(e,t)-Math.min(e,t),l=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1]],s=([e,t])=>[[e-1,t],[e+1,t],[e,t-1],[e,t+1],[e-1,t-1],[e+1,t-1],[e-1,t+1],[e+1,t+1]],h=(e,t,n)=>l(t).filter(t=>e[t[1]][t[0]]===n),r=([e,t],[n,l])=>Math.hypot(o(e,n),o(t,l)),g=(e,t)=>{let n,o=25600;for(let l=0;l<t.length;l++){let s=r(e,t[l]);s<o&&(o=s,n=t[l])}return n},u=([e,t],n)=>{let o=[],s=[[e,t,0]],h=[],r=([e,t,r])=>{C([e,t])&&n([e,t])&&(h[160*t+e]||(o.push([e,t,r]),h[160*t+e]=1,s.push(...l([e,t]).map(([e,t])=>[e,t,r+1]))))};for(;s.length;)r(s.shift());return o},i=([e,t],[n,l])=>{let s=o(e,n),h=o(t,l),r=e,c=t;return s>h&&(n>e&&(r=e+1),e>n&&(r=e-1)),h>s&&(l>t&&(c=t+1),t>l&&(c=t-1)),[r,c]},f=([e,n],[o,s],h=C,r=.66)=>{let c=[],g=[],u=([e,n])=>{g[160*n+e]||(c.push([e,n]),g[160*n+e]=1),e===o&&n===s||u(Math.random()<r?t(l([e,n]).filter(h))||[e,n]:i([e,n],[o,s]))};return u([e,n]),c},a=e=>[3===e?20:1===e?140:n(120,20),0===e?20:2===e?140:n(120,20)],d=()=>[n(120,20),n(120,20)],p=(e,[t,n])=>{for(let o=0;o<e.length;o++)if(e[o][0]===t&&e[o][1]===n)return!0;return!1},C=([e,t])=>e>=0&&e<=159&&t>=0&&t<=159,S=([e,t])=>e>=8&&e<=152&&t>=8&&t<=152,I=()=>{let e=[];for(let t=0;t<160;t++){let t=[];for(let e=0;e<160;e++)t.push(1);e.push(t)}return e},m=(e,t,n)=>{for(let o=0;o<t.length;o++){let[l,s]=t[o];e[s][l]=n([l,s])}},E=e=>{let t=0;let o=(e=>e.slice().sort(()=>n(3)-1))([0,3,6,9]);for(let l=0;l<160;l++)for(let s=0;s<160;s++)if(1===e[l][s]){let h=u([s,l],([t,n])=>1===e[n][t]);let r=0;h.length>5&&(r=t<4?o[t]:n(10),t++),m(e,h,r<3?()=>n(9)+2:r<6?()=>n(3)?n(4)+11:n(9)+2:r<9?()=>n(4)?n(3)+31:n(9)+2:()=>0)}},N=()=>{let e=I(),o=n(10,40),r=[a(0),a(1),a(2),a(3)];for(;r.length<o;)r.push(d());let c=[],i=r.slice();let p=i.pop();let C=p;for(;i.length;){let e=g(p,i),t=f(p,e,S,.33);c.push(...t),p=i.pop()}let N=f(p,C,S,.33);c.push(...N);for(let e=0;e<10;e++){let e=f(t(r),t(r),S,.33);c.push(...e)}let k=[];for(let e=0;e<r.length;e++)k.push(...s(r[e]));let y=((e,n=8448)=>{let o=e.slice(),s=[];for(let e=0;e<o.length;e++){let[t,n]=o[e];s[160*n+t]=1}for(;o.length<n;){let[e,n]=t(o),h=l([e,n]);if(h.length){let[e,n]=t(h);s[160*n+e]||(o.push([e,n]),s[160*n+e]=1)}}return o})((e=>{let t=[],n=[];for(let o=0;o<e.length;o++){let[l,s]=e[o];n[160*s+l]||(t.push(e[o]),n[160*s+l]=1)}return console.log("unique",e.length,t.length),t})([...r,...k,...c])),[R,M]=(e=>{let t=160,n=[0,0];for(let o=0;o<e.length;o++){let[l,s]=e[o];l<t&&(t=l,n=[l,s])}return n})(y);m(e,y,()=>2);let O=u([0,0],([t,n])=>1===e[n][t]);return m(e,O,()=>0),E(e),(e=>{for(let t=0;t<160;t++)for(let o=0;o<160;o++)2===e[t][o]&&(h(e,[o,t],0).length?e[t][o]=n(3)+17:e[t][o]=n(13)+2)})(e),m(e,c,([t,n])=>e[n][t]>=17&&e[n][t]<20?e[n][t]:2),m(e,k,([t,o])=>e[o][t]>=17&&e[o][t]<20?e[o][t]:n(9)+2),m(e,r,()=>20),[3,R,M,e,0,R,M]},k=e=>e<2||e>=11&&e<15||20===e||27===e||24===e||25===e||26===e||21===e||22===e||23===e||e>=28&&e<31||e>=31&&e<34,y=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","--------------------","MAIN MENU","","ERROR:"," SYSTEM OFFLINE","","EMERGENCY OPS:",""],[["DIAGNOSTICS",5],["SYNTHESIZE",6]],0,"a"],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","","MAIN SYSTEM:"," OFFLINE",""," PROBLEM:","  6 CAPS BLOWN","","SYNTHESIZE:"," ONLINE"],[],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","","SYNTHDB:"," OFFLINE","","EMERGENCY OPS:",""],[["BASIC RATIONS",-1]],0,"a"],N(),[1,["I should","investigate"]],[2,["Sleep?"],[["Yes",11],["No",-1]],0,"g"],[1,["I'm not tired!"]],[4,0],[1,["I'm hungry!"]],[1,["You died"]]],R=e=>{let t=D[0]()[6],n=D[0]()[7];c.className=t,c.width=c.height=160,3===n[0]&&(A(e),Y()),0===n[0]&&"s.png"===n[1]&&$.drawImage(L,0,0),1===n[0]&&w(n[1]),2===n[0]&&T(n),requestAnimationFrame(R)},M=(e="",t=0,n=0)=>$.drawImage(v,8*(e.charCodeAt(0)-32),0,8,8,8*t,8*n,8,8),O=(e="",t=0,n=0)=>{for(let o=0;o<e.length;o++)M(e[o],t+o,n)},w=e=>{let t=~~((20-e.length)/2);for(let n=0;n<e.length;n++){let o=~~((20-e[n].length)/2);O(e[n],o,t+n)}},T=e=>{for(let t=0;t<e[1].length;t++)O(e[1][t],0,t);O("<X>",17,0);let t=e[1].length%2?1:0;for(let n=0;n<e[2].length;n++)O(`${n+1} ${n===e[3]?"<":" "}${e[2][n][0]}${n===e[3]?">":" "}`,0,2*n+e[1].length+t)},A=e=>{let t=~~(e/500)%2?0:1,n=D[0]()[8],o=D[0]()[7],l=o[3],s=o[1],h=o[2],r=o[4],c=o[5],g=o[6],u=D[0]()[2],i=D[0]()[0],f=D[0]()[4]>=18||D[0]()[4]<6;for(let e=0;e<9;e++)for(let o=0;o<9;o++){let a=s-4+o,d=h-4+e;let p=16*t;if(C([a,d])){let e=l[d][a];e&&(p=16*e)}if($.drawImage(F,p,0,16,16,16*(o+1),16*(e+1),16,16),0===r&&f)for(let l=0;l<n.length;l++){let s=n[l],h=s[0],r=s[1],c=s[2];h===a&&r===d&&s[3]>0&&(p=16*(7+t)+16*c*2,$.drawImage(B,p,0,16,16,16*(o+1),16*(e+1),16,16))}4===o&&4===e&&(p=u?16*t+16*i*2:64,$.drawImage(B,p,0,16,16,16*(o+1),16*(e+1),16,16)),0===r&&a===c-2&&d===g&&$.drawImage(B,80,0,16,16,16*(o+1),16*(e+1),16,16),0===r&&a===c-1&&d===g&&$.drawImage(B,96,0,16,16,16*(o+1),16*(e+1),16,16)}},Y=()=>{let e=D[0]()[1],t=D[0]()[2];O(`RANGER DOWN   ${D[2]()}`,.5,.5),$.drawImage(F,256,0,16,16,0,16,16,16),O(`${t}`,t<10?.5:0,4),$.drawImage(F,240,0,16,16,0,48,16,16),O(`${e}`,e<10?.5:0,8)},$=c.getContext("2d");let v,F,B,L,D=(()=>{let e,t,o,l,s,h,r,c,g;let f=()=>{e=0,t=10,o=10,l=10,s=17,h=55,y[7]=N(),c=[y[7],y[1],y[0]],r="",g=[],d()},a=()=>{c.pop(),c.length||f()},d=()=>{for(;g.length<53;){let e=n(160),t=n(160),o=n(2),l=n(2)+1,s=y[7],h=s[3][t][e],r=s[1],c=s[2];k(h)||p(g,[e,t])||r===e&&c===t||g.push([e,t,o,l])}},S=()=>{for(let e=0;e<g.length;e++){let t=g[e],l=t[0],h=t[1],r=c[c.length-1],u=y[7],f=u[1],a=u[2],d=[l,h];if(Math.random()<.66){let e=i([l,h],[f,a]);d[0]=e[0],d[1]=e[1]}else n(2)?d[0]=l+(n(3)-1):d[1]=h+(n(3)-1);let C=u[3][d[1]][d[0]];k(C)||p(g,[d[0],d[1]])||f===d[0]&&a===d[1]||(t[0]=d[0],t[1]=d[1],d[0]<l&&(t[2]=1),d[0]>l&&(t[2]=0)),3===r[0]&&0===r[4]&&(s>=18||s<6)&&f===d[0]&&a===d[1]&&n(2)&&o>0&&t[3]>0&&o--}},E=()=>{o<1?c=[y[13]]:(60==++h&&(h=0,6==++s&&(r="",c.push(y[2])),18===s&&(r="i",c.push(y[3])),t>0?(t--,o<l&&o++):(o--,c.push(y[12]))),24===s&&(s=0),S())},R=[()=>{for(;5!==s||59!==h;)60==++h&&(h=0,s++,o<l&&o++),24===s&&(s=0),S()}];return f(),[()=>[e,t,o,l,s,h,(()=>0===c[c.length-1][0]?"g":1===c[c.length-1][0]?"g":2===c[c.length-1][0]?c[c.length-1][4]:r)(),c[c.length-1],g],f,()=>`${s<10?"0":""}${s}:${h<10?"0":""}${h}`,E,(t,l)=>{let h=c[c.length-1];if(3!==h[0])return;let r;if(E(),-1===t&&(e=1),1===t&&(e=0),t=h[1]+t,l=h[2]+l,(s>=18||s<6)&&0===h[4])for(let e=0;e<g.length;e++)g[e][0]===t&&g[e][1]===l&&g[e][3]>0&&(r=g[e]);o>0&&C([t,l])&&!k(h[3][l][t])&&!r&&(h[1]=t,h[2]=l),0===h[4]&&(20===h[3][l][t]&&c.push((()=>{let e=I(),t=u([0,0],([t,n])=>1===e[n][t]);return m(e,t,()=>27),e[19][18]=21,e[19][19]=22,e[19][20]=23,e[20][18]=2,e[20][19]=2,e[20][20]=2,e[21][18]=24,e[21][19]=25,e[21][20]=26,[3,20,20,e,1,20,20]})()),l===h[6]&&t===h[5]-1&&c.push(y[8]),r&&n(2)&&r[3]--),1===h[4]&&(26===h[3][l][t]&&c.pop(),21===h[3][l][t]&&c.push(y[4]),23===h[3][l][t]&&(s>=18||s<6?c.push(y[9]):c.push(y[10])))},a,e=>{2===c[c.length-1][0]&&(c[c.length-1][3]=e)},()=>{if(2===c[c.length-1][0]){let e=c[c.length-1];if(!e[2].length)return void c.pop();let t=e[3],n=e[2][t][1];-1===n?a():4===y[n][0]?(R[y[n][1]](),c.pop()):c.push(y[n])}}]})();document.onkeyup=(e=>{let t=D[0]()[7];if(3===t[0]&&(e=>{65!==e.keyCode&&37!==e.keyCode||D[4](-1,0),68!==e.keyCode&&39!==e.keyCode||D[4](1,0),87!==e.keyCode&&38!==e.keyCode||D[4](0,-1),83!==e.keyCode&&40!==e.keyCode||D[4](0,1)})(e),0!==t[0]&&1!==t[0]||32!==e.keyCode&&27!==e.keyCode&&13!==e.keyCode||D[5](),2===t[0]){let n=t;27===e.keyCode&&D[5](),87!==e.keyCode&&38!==e.keyCode||n[3]>0&&D[6](n[3]-1),83!==e.keyCode&&40!==e.keyCode||n[3]<n[2].length-1&&D[6](n[3]+1),32!==e.keyCode&&13!==e.keyCode||D[7]()}});let G=([e,t])=>{let n=D[0]()[7],l=c.getBoundingClientRect().width/10,s=~~((e-c.getBoundingClientRect().left)/l)-1,h=~~((t-c.getBoundingClientRect().top)/l)-1;if(3===n[0]){if(4===s&&4===h)return;if(s<0||h<0)return;let e=o(s,4),t=o(h,4);let n=0,l=0;e>t?n=s>4?1:-1:e<t&&(l=h>4?1:-1),D[4](n,l)}if(0!==n[0]&&1!==n[0]||D[5](),2===n[0]){h<0&&D[5]();let e=n,t=e[1].length%2?1:0,o=(e[1].length+t)/2,l=e[2].length,s=h-o+1;s>=0&&s<l&&(s===e[3]?D[7]():D[6](s))}};c.ontouchend=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)G([e.changedTouches[t].clientX,e.changedTouches[t].clientY])}),c.onclick=(e=>{e.preventDefault(),G([e.clientX,e.clientY])}),((...t)=>Promise.all(t.map(e)))("f.gif","t.gif","p.gif","s.png").then(e=>{[v,F,B,L]=e,requestAnimationFrame(R)})};s();