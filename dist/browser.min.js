let s=()=>{let t=t=>new Promise(e=>{let n=new Image;n.onload=(()=>e(n)),n.src=t}),e=t=>t[n(t.length)],n=(t,e=0)=>~~(Math.random()*t)+e,o=(t,e)=>Math.max(t,e)-Math.min(t,e),r=([t,e])=>[[t-1,e],[t+1,e],[t,e-1],[t,e+1]],s=(t,e,n)=>r(e).filter(e=>t[e[1]][e[0]]===n),l=(t,[n,r],s,l)=>{let h=t.filter(([t,e])=>o(t,n)>=s&&o(e,r)>=s&&o(t,n)<=l&&o(e,r)<=l);return e(h)},h=([t,e],n)=>{let o=[],s=[[t,e,0]],l=[],h=([t,e,h])=>{p([t,e])&&n([t,e])&&(l[128*e+t]||(o.push([t,e,h]),l[128*e+t]=!0,s.push(...r([t,e]).map(([t,e])=>[t,e,h+1]))))};for(;s.length;)h(s.shift());return o},g=(t,[e,n])=>{let o=[],[s,l]=t[0],h=((t,[e,n])=>{for(let o=0;o<t.length;o++)if(t[o][0]===e&&t[o][1]===n)return t[o]})(t,[e,n]);if(!h)return o;let c=[h],g=([e,n,h])=>{if(o.unshift([e,n]),e===s&&n===l)return;let g;r([e,n]).forEach(([e,n])=>{let o=t.find(([t,o])=>t===e&&o===n);if(o){let[,,t]=o;t<h&&(h=t,g=o)}}),g&&c.push(g)};for(;c.length;)g(c.shift());return o},f=([t,e],[n,r])=>{let s=o(t,n),l=o(e,r),h=t,c=e;return s>l&&(n>t&&(h=t+1),t>n&&(h=t-1)),l>s&&(r>e&&(c=e+1),e>r&&(c=e-1)),[h,c]},a=([t,n],[o,s],l=p,h=.66)=>{let c=[],g=([t,n])=>{d(c,[t,n])||c.push([t,n]),t===o&&n===s||g(Math.random()<h?e(r([t,n]).filter(l))||[t,n]:f([t,n],[o,s]))};return g([t,n]),c},i=t=>[3===t?21:1===t?107:n(86,21),0===t?21:2===t?107:n(86,21)],u=()=>[n(86,21),n(86,21)],d=(t,[e,n])=>{for(let o=0;o<t.length;o++)if(t[o][0]===e&&t[o][1]===n)return!0;return!1},p=([t,e])=>t>=0&&t<=127&&e>=0&&e<=127,S=([t,e])=>t>=8&&t<=120&&e>=8&&e<=120,C=()=>{let t=[];for(let e=0;e<128;e++){let e=[];for(let t=0;t<128;t++)e.push(1);t.push(e)}return t},E=(t,e,n)=>{for(let o=0;o<e.length;o++){let[r,s]=e[o];t[s][r]=n([r,s])}},I=()=>{let t=C(),o=n(15,10),r=[i(0),i(1),i(2),i(3)];for(let t=4;t<o;t++)r.push(u());for(let e=1;e<o;e++){let n=a(r[e-1],r[e],S);E(t,n,()=>2)}let c=((t,e)=>{let n=[];for(let o=0;o<128;o++)for(let r=0;r<128;r++)t[o][r]===e&&n.push([r,o]);return n})(t,2),f=c.slice();((t,n,o=4096)=>{for(;n.length<o;){let[o,r]=e(n),l=s(t,[o,r],1).filter(S);if(l.length){let[o,r]=e(l);d(n,[o,r])||(n.push([o,r]),t[r][o]=2)}}})(t,c);let p=h([0,0],([e,n])=>1===t[n][e]);E(t,p,()=>0),((t,e)=>{for(let o=0;o<128;o++)for(let r=0;r<128;r++)2===t[o][r]&&(s(t,[r,o],0).length?t[o][r]=n(3)+14:d(e,[r,o])?t[o][r]=n(6)+2:t[o][r]=n(7)+2),1===t[o][r]&&(t[o][r]=n(2)+7)})(t,f);let[I,m]=(t=>{let e=128,n=[0,0];for(let o=0;o<t.length;o++){let[r,s]=t[o];r<e&&(e=r,n=[r,s])}return n})(c);let N;for(;!N;)N=l(f,[I,m],n(5)+10,n(5)+20);let[k,y]=N,[O,R]=l(f,[k,y],n(5)+10,n(5)+20),M=[[I,m],[k,y],[O,R]];for(;M.length<15;){let[o,r]=e(M),s=12*n(10),c=12*n(10),a=l(f,[s,c],1,12),i=h([o,r],([e,n])=>0!==t[n][e]);if(a&&i.length){let e=g(i,a);M.push(a),E(t,e,([e,n])=>t[n][e]>=14&&t[n][e]<17?t[n][e]:2)}}for(let e=2;e<15;e++){let[n,o]=M[e];t[o][n]=17}return[3,I,m,t,0,I,m]},m=t=>t<2||8===t||17===t||24===t||21===t||22===t||23===t||18===t||19===t||20===t,N=[[0,"s.png"],[1,["Lost contact with","RANGER. Take boat","and investigate."]],[1,["Sunrise"]],[1,["Sunset"]],[2,["RSOS v3.27","--------------------","MAIN MENU","--------------------","ERROR:"," SYSTEM OFFLINE","","EMERGENCY OPS:","===================="],[["DIAGNOSTICS",5],["SYNTHESIZE",6]],0,"a"],[2,["RSOS v3.27","--------------------","DIAGNOSTICS MENU","--------------------","MAIN SYSTEM:"," OFFLINE",""," PROBLEM:","  6 CAPS BLOWN","","SYNTHESIZE:"," ONLINE"],[],0,"a"],[2,["RSOS v3.27","--------------------","SYNTHESIZER MENU","--------------------","SYNTHDB:"," OFFLINE","","EMERGENCY OPS:","===================="],[["BASIC RATIONS",4]],0,"a"],I(),[1,["I should","investigate"]]],k=t=>{let e=G[0]()[6],n=G[0]()[7];c.className=e,c.width=c.height=160,3===n[0]&&(w(t),T()),0===n[0]&&"s.png"===n[1]&&A.drawImage(L,0,0),1===n[0]&&R(n[1]),2===n[0]&&M(n),requestAnimationFrame(k)},y=(t="",e=0,n=0)=>A.drawImage($,8*(t.charCodeAt(0)-32),0,8,8,8*e,8*n,8,8),O=(t="",e=0,n=0)=>{for(let o=0;o<t.length;o++)y(t[o],e+o,n)},R=t=>{let e=~~((20-t.length)/2);for(let n=0;n<t.length;n++){let o=~~((20-t[n].length)/2);O(t[n],o,e+n)}},M=t=>{for(let e=0;e<t[1].length;e++)O(t[1][e],0,e);O("<X>",17,0);let e=t[1].length%2?1:0;for(let n=0;n<t[2].length;n++)O(`${n+1} ${n===t[3]?"<":" "}${t[2][n][0]}${n===t[3]?">":" "}`,0,2*n+t[1].length+e)},w=t=>{let e=~~(t/500)%2?0:1,n=G[0]()[8],o=G[0]()[7],r=o[3],s=o[1],l=o[2],h=o[4],c=o[5],g=o[6],f=G[0]()[2],a=G[0]()[0],i=G[0]()[4]>=18||G[0]()[4]<6;for(let t=0;t<9;t++)for(let o=0;o<9;o++){let u=s-4+o,d=l-4+t;let S=16*e;if(p([u,d])){let t=r[d][u];t&&(S=16*t)}if(A.drawImage(Y,S,0,16,16,16*(o+1),16*(t+1),16,16),0===h&&i)for(let r=0;r<n.length;r++){let s=n[r],l=s[0],h=s[1],c=s[2];l===u&&h===d&&s[3]>0&&(S=16*(7+e)+16*c*2,A.drawImage(F,S,0,16,16,16*(o+1),16*(t+1),16,16))}4===o&&4===t&&(S=f?16*e+16*a*2:64,A.drawImage(F,S,0,16,16,16*(o+1),16*(t+1),16,16)),0===h&&u===c-2&&d===g&&A.drawImage(F,80,0,16,16,16*(o+1),16*(t+1),16,16),0===h&&u===c-1&&d===g&&A.drawImage(F,96,0,16,16,16*(o+1),16*(t+1),16,16)}},T=()=>{let t=G[0]()[1],e=G[0]()[2];O(`RANGER DOWN   ${G[2]()}`,.5,.5),A.drawImage(Y,160,0,16,16,0,16,16,16),O(`${e}`,e<10?.5:0,4),A.drawImage(Y,144,0,16,16,0,48,16,16),O(`${t}`,t<10?.5:0,8)},A=c.getContext("2d");let $,Y,F,L,G=(()=>{let t,e,o,r,s,l,c,g,a;let i=()=>{t=0,e=5,o=2,r=10,s=6,l=55,N[7]=I(),g=[N[7],N[1],N[0]],c="",a=[],u()},u=()=>{for(;a.length<42;){let t=n(128),e=n(128),o=n(2),r=n(2)+1,s=N[7],l=s[3][e][t],h=s[1],c=s[2];m(l)||d(a,[t,e])||h===t&&c===e||a.push([t,e,o,r])}},S=()=>{o<1||(60==++l&&(l=0,6==++s&&(c="",g.push(N[2])),18===s&&(c="i",g.push(N[3])),e>0?(e--,o<r&&o++):o--),24===s&&(s=0),(()=>{for(let t=0;t<a.length;t++){let e=a[t],r=e[0],l=e[1],h=g[g.length-1],c=N[7],i=c[1],u=c[2],p=[r,l];if(Math.random()<.66){let t=f([r,l],[i,u]);p[0]=t[0],p[1]=t[1]}else n(2)?p[0]=r+(n(3)-1):p[1]=l+(n(3)-1);let S=c[3][p[1]][p[0]];m(S)||d(a,[p[0],p[1]])||i===p[0]&&u===p[1]||(e[0]=p[0],e[1]=p[1],p[0]<r&&(e[2]=1),p[0]>r&&(e[2]=0)),3===h[0]&&0===h[4]&&(s>=18||s<6)&&i===p[0]&&u===p[1]&&n(2)&&o>0&&e[3]>0&&o--}})())};return i(),[()=>[t,e,o,r,s,l,(()=>0===g[g.length-1][0]?"g":1===g[g.length-1][0]?"g":2===g[g.length-1][0]?g[g.length-1][4]:c)(),g[g.length-1],a],i,()=>`${s<10?"0":""}${s}:${l<10?"0":""}${l}`,S,(e,r)=>{let l=g[g.length-1];if(3!==l[0])return;let c;if(S(),-1===e&&(t=1),1===e&&(t=0),e=l[1]+e,r=l[2]+r,(s>=18||s<6)&&0===l[4])for(let t=0;t<a.length;t++)a[t][0]===e&&a[t][1]===r&&a[t][3]>0&&(c=a[t]);o>0&&p([e,r])&&!m(l[3][r][e])&&!c&&(l[1]=e,l[2]=r),0===l[4]&&(17===l[3][r][e]&&g.push((()=>{let t=C(),e=h([0,0],([e,n])=>1===t[n][e]);return E(t,e,()=>24),t[20][19]=18,t[20][20]=19,t[20][21]=20,t[21][19]=2,t[21][20]=2,t[21][21]=2,t[22][19]=21,t[22][20]=22,t[22][21]=23,[3,21,21,t,1,21,21]})()),r===l[6]&&e===l[5]-1&&g.push(N[8]),c&&n(2)&&c[3]--),1===l[4]&&(23===l[3][r][e]&&g.pop(),18===l[3][r][e]&&g.push(N[4]))},()=>{g.pop(),g.length||(g=[N[7]])},t=>{2===g[g.length-1][0]&&(g[g.length-1][3]=t)},()=>{if(2===g[g.length-1][0]){let t=g[g.length-1],e=t[3],n=t[2][e][1];g.push(N[n])}}]})();document.onkeyup=(t=>{let e=G[0]()[7];if(3===e[0]&&(t=>{65!==t.keyCode&&37!==t.keyCode||G[4](-1,0),68!==t.keyCode&&39!==t.keyCode||G[4](1,0),87!==t.keyCode&&38!==t.keyCode||G[4](0,-1),83!==t.keyCode&&40!==t.keyCode||G[4](0,1)})(t),0!==e[0]&&1!==e[0]||32!==t.keyCode&&27!==t.keyCode&&13!==t.keyCode||G[5](),2===e[0]){let n=e;27===t.keyCode&&G[5](),87!==t.keyCode&&38!==t.keyCode||n[3]>0&&G[6](n[3]-1),83!==t.keyCode&&40!==t.keyCode||n[3]<n[2].length-1&&G[6](n[3]+1),32!==t.keyCode&&13!==t.keyCode||G[7]()}}),c.ontouchend=(t=>{let e=G[0]()[7];for(let n=0;n<t.changedTouches.length;n++){let r=c.getBoundingClientRect().width/10,s=~~(t.changedTouches[n].clientX/r)-1,l=~~(t.changedTouches[n].clientY/r)-1;if(3===e[0]){if(4===s&&4===l)return;if(s<0||l<0)return;let t=o(s,4),e=o(l,4);let n=0,r=0;t>e?n=s>4?1:-1:t<e&&(r=l>4?1:-1),G[4](n,r)}if(0!==e[0]&&1!==e[0]||G[5](),2===e[0]){l<0&&G[5]();let t=e,n=t[1].length%2?1:0,o=(t[1].length+n)/2,r=t[2].length,s=l-o+1;s>=0&&s<r&&(s===t[3]?G[7]():G[6](s))}}}),((...e)=>Promise.all(e.map(t)))("f.gif","t.gif","p.gif","s.png").then(t=>{[$,Y,F,L]=t,requestAnimationFrame(k)})};s();